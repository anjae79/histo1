<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조직병리핵심센터 분석 신청서</title>
    
    <!-- PDF 생성 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Google reCAPTCHA v2 -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <style>
        /* 캡처 시 빨간 표시 숨김 */
        .capturing {
            --capture-mode: true;
        }
        
        .capturing input:invalid,
        .capturing input:required:invalid,
        .capturing textarea:invalid,
        .capturing textarea:required:invalid {
            border-color: #ddd !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        .capturing .required {
            color: #333 !important;
        }
        
        .capturing .error-message,
        .capturing .validation-error,
        .capturing .form-error,
        .capturing #recaptcha-container,
        .capturing .submit-section {
            display: none !important;
        }
        
        .capturing input:focus,
        .capturing textarea:focus,
        .capturing select:focus {
            border-color: #ddd !important;
            box-shadow: none !important;
            outline: none !important;
        }
    </style>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            line-height: 1.2;
            margin: 0;
            padding: 8px;
            background-color: #f5f5f5;
            font-size: 11px;
        }
        
        .application-form {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 12px;
            border-bottom: 2px solid #005baa;
            padding-bottom: 8px;
            position: relative;
        }
        
        .form-header h1 {
            color: #005baa;
            margin: 2px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-header .subtitle {
            color: #666;
            margin-top: 4px;
            font-size: 12px;
        }
        
        .form-section {
            margin-bottom: 8px;
        }
        
        .section-title {
            background: linear-gradient(90deg, #005baa 0%, #00A54D 100%);
            color: white;
            padding: 4px 8px;
            margin: 0 0 6px 0;
            font-weight: bold;
            font-size: 11px;
        }
        
        .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 6px;
        }
        
        .form-table th,
        .form-table td {
            border: 1px solid #ddd;
            padding: 3px 6px;
            text-align: left;
            vertical-align: top;
            font-size: 10px;
        }
        
        .form-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%);
            font-weight: bold;
            width: 100px;
            color: #005baa;
        }
        
        .form-table input[type="text"],
        .form-table input[type="email"],
        .form-table input[type="tel"],
        .form-table input[type="date"],
        .form-table input[type="number"],
        .form-table textarea,
        .form-table select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            box-sizing: border-box;
        }
        
        .form-table textarea {
            resize: vertical;
            min-height: 30px;
        }
        
        .services-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 4px;
        }
        
        .services-table th,
        .services-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            font-size: 10px;
        }
        
        .services-table th {
            background: linear-gradient(135deg, #005baa 0%, #00A54D 100%);
            color: white;
            font-weight: bold;
        }
        
        .services-table input[type="number"],
        .services-table input[type="text"],
        .services-table select {
            width: 100%;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 11px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.0);
            accent-color: #00A54D !important;
        }
        
        /* 모든 체크박스에 초록색 적용 - 강력한 우선순위 */
        input[type="checkbox"] {
            accent-color: #00A54D !important;
        }
        
        /* WebKit 기반 브라우저용 체크박스 스타일 */
        input[type="checkbox"]:checked {
            background-color: #00A54D !important;
            border-color: #00A54D !important;
        }
        
        /* Firefox용 체크박스 스타일 */
        input[type="checkbox"]:checked::-moz-checkbox {
            background-color: #00A54D !important;
            border-color: #00A54D !important;
        }
        
        /* 체크박스 체크 표시 색상 강제 적용 */
        input[type="checkbox"]:checked::before {
            color: white !important;
        }
        
        .signature-section {
            margin-top: 8px;
            text-align: right;
            font-size: 10px;
        }
        
        .signature-box {
            display: inline-block;
            border: 2px solid #005baa;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%);
            width: 80px;
            height: 30px;
            margin-left: 8px;
            vertical-align: top;
        }
        
        .form-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 10px;
        }
        
        .required {
            color: #00A54D;
            font-weight: bold;
        }
        
        .receipt-number-section {
            margin-bottom: 4px;
            display: flex;
            justify-content: flex-end;
        }
        
        .receipt-number-box {
            border: 1px solid #005baa;
            padding: 3px;
            border-radius: 3px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%);
            width: 160px;
        }
        
        .receipt-number-box label {
            display: block;
            font-weight: bold;
            color: #005baa;
            margin-bottom: 4px;
            font-size: 11px;
        }

        /* 인쇄용 스타일 - 데스크톱 레이아웃 유지 */
        @media print {
            @page {
                margin: 25mm 15mm 25mm 15mm;
                size: A4;
            }
            
            body {
                background-color: white !important;
                font-size: 9px !important;
                line-height: 1.1 !important;
                color: black !important;
                margin: 0 !important;
                padding: 0 !important;
                display: block !important;
            }
            
            .application-form {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                transform: none !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .form-header {
                margin-bottom: 8px !important;
                padding-bottom: 6px !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            
            .form-header h1 {
                color: black !important;
                font-size: 18px !important;
                margin: 0 0 4px 0 !important;
                padding: 0 !important;
            }
            
            .form-header .subtitle {
                color: black !important;
                font-size: 12px !important;
                margin: 0 !important;
            }
            
            .section-title {
                background: linear-gradient(90deg, #005baa 0%, #00A54D 100%) !important;
                color: white !important;
                padding: 5px 8px !important;
                margin: 6px 0 6px 0 !important;
                font-size: 12px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .form-section {
                margin-bottom: 6px !important;
            }
            
            .form-table,
            .services-table {
                margin-bottom: 5px !important;
            }
            
            .form-table th,
            .form-table td,
            .services-table th,
            .services-table td {
                padding: 3px 5px !important;
                font-size: 10px !important;
                line-height: 1.2 !important;
            }
            
            .form-table th,
            .services-table th {
                background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%) !important;
                color: #005baa !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .form-table input,
            .form-table textarea,
            .form-table select,
            .services-table input,
            .services-table select {
                font-size: 9px !important;
                padding: 2px !important;
            }
            
            .form-table textarea {
                min-height: 12px !important;
            }
            
            .checkbox-group {
                gap: 2px !important;
            }
            
            .checkbox-item {
                font-size: 9px !important;
                gap: 2px !important;
            }
            
            .checkbox-item input[type="checkbox"] {
                transform: scale(0.8) !important;
            }
            
            h5 {
                font-size: 9px !important;
                margin: 3px 0 !important;
            }
            
            div[style*="grid-template-columns"] {
                gap: 4px !important;
                margin-bottom: 3px !important;
            }
            
            .receipt-number-box {
                background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%) !important;
                border-color: #005baa !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .receipt-number-box label {
                color: #005baa !important;
            }
            
            .signature-box {
                background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%) !important;
                border-color: #005baa !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .required {
                color: #00A54D !important;
            }
            
            h5 {
                color: #005baa !important;
            }
            
            .checkbox-item input[type="checkbox"] {
                accent-color: #00A54D !important;
            }
            
            /* 색상 유지 강제 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        
        .receipt-number-box input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            box-sizing: border-box;
            text-align: center;
            font-weight: bold;
        }
        
        .print-btn {
            background: linear-gradient(90deg, #005baa 0%, #00A54D 100%);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin: 10px 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .print-btn:hover {
            background: linear-gradient(90deg, #004494 0%, #008a42 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* 모바일 반응형 스타일 */
        @media screen and (max-width: 768px) {
            body {
                font-size: 12px;
                padding: 4px;
            }
            
            .application-form {
                max-width: 100%;
                margin: 0;
                padding: 10px;
                border-radius: 4px;
            }
            
            .form-header h1 {
                font-size: 16px;
                margin: 4px 0;
            }
            
            .form-header .subtitle {
                font-size: 11px;
            }
            
            .section-title {
                font-size: 12px;
                padding: 6px 8px;
                margin-bottom: 8px;
            }
            
            .form-table {
                display: block;
                overflow-x: auto;
                border: none;
            }
            
            .form-table tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 8px;
                background: #f9f9f9;
            }
            
            .form-table th,
            .form-table td {
                display: block;
                width: 100% !important;
                border: none;
                padding: 4px 0;
                text-align: left;
            }
            
            .form-table th {
                background: none;
                color: #2c5282;
                font-weight: bold;
                margin-bottom: 4px;
                font-size: 12px;
            }
            
            .form-table input,
            .form-table select,
            .form-table textarea {
                width: 100%;
                font-size: 14px;
                padding: 8px;
                border-radius: 4px;
            }
            
            .services-table {
                display: block;
                overflow-x: auto;
                border: none;
            }
            
            .services-table thead {
                display: none;
            }
            
            .services-table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px;
                background: #f9f9f9;
            }
            
            .services-table td {
                display: block;
                width: 100%;
                border: none;
                padding: 4px 0;
                position: relative;
                text-align: left;
            }
            
            .services-table td:before {
                content: attr(data-label) ": ";
                font-weight: bold;
                color: #2c5282;
                display: block;
                margin-bottom: 2px;
                font-size: 11px;
            }
            
            .services-table input,
            .services-table select {
                width: 100%;
                font-size: 14px;
                padding: 6px;
                border-radius: 4px;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .checkbox-item {
                font-size: 12px;
                align-items: flex-start;
            }
            
            .checkbox-item input[type="checkbox"] {
                transform: scale(1.2);
                margin-right: 8px;
            }
            
            .receipt-number-section {
                justify-content: center;
                margin-bottom: 8px;
            }
            
            .receipt-number-box {
                width: 100%;
                max-width: 250px;
                padding: 8px;
            }
            
            .receipt-number-box label {
                font-size: 12px;
            }
            
            .receipt-number-box input {
                font-size: 14px;
                padding: 6px;
            }
            
            .signature-section {
                text-align: center;
                margin-top: 15px;
            }
            
            .signature-section p {
                margin-bottom: 8px;
                font-size: 12px;
            }
            
            .signature-box {
                width: 100px;
                height: 40px;
                margin: 0 auto;
                display: block;
            }
            
            .form-footer {
                text-align: center;
                font-size: 11px;
                line-height: 1.4;
            }
            
            .form-footer p {
                margin-bottom: 6px;
            }
            
            .print-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                margin-top: 15px;
                border-radius: 6px;
            }
            
            /* 분석 선택 그리드를 모바일에서 단일 컬럼으로 */
            div[style*="grid-template-columns"] {
                display: block !important;
            }
            
            div[style*="grid-template-columns"] > div {
                margin-bottom: 15px;
            }
            
            h5 {
                font-size: 13px !important;
                margin: 8px 0 !important;
            }
        }
        

    </style>
</head>
<body>
    <div class="application-form">
        <div class="form-header">
            <h1>부산대학교 의과대학 조직병리코어센터</h1>
            <h1>신청서</h1>
            <div class="subtitle">Histopathology Core Center Request Form</div>
        </div>

        <form id="applicationForm">
            <!-- 접수번호 -->
            <div class="receipt-number-section">
                <div class="receipt-number-box">
                    <label for="receipt_number_top">접수번호 (Receipt No.)</label>
                    <input type="text" id="receipt_number_top" name="receipt_number_top" placeholder="자동 생성됩니다" readonly style="background-color: #f8f9fa;">
                </div>
            </div>
            
            <!-- 신청자 정보 -->
            <div class="form-section">
                <div class="section-title">■ 신청자 정보 (Applicant Information)</div>
                <table class="form-table">
                    <tr>
                        <th style="width: 80px;">신청일 <span class="required">*</span></th>
                        <td style="width: 120px;"><input type="date" name="application_date" required></td>
                        <th style="width: 100px;">신청자/담당교수 <span class="required">*</span></th>
                        <td colspan="3"><input type="text" name="applicant_name" placeholder="신청자/담당교수" autocomplete="name" required></td>
                    </tr>
                    <tr>
                        <th style="width: 80px;">소속기관 <span class="required">*</span></th>
                        <td style="width: 200px;"><input type="text" name="institution" placeholder="소속기관" autocomplete="organization" required></td>
                        <th style="width: 80px;">부서/학과</th>
                        <td colspan="3"><input type="text" name="department" placeholder="부서/학과를 입력하세요" autocomplete="organization-title"></td>
                    </tr>
                    <tr>
                        <th style="width: 80px;">연락처 <span class="required">*</span></th>
                        <td style="width: 200px;"><input type="tel" name="phone" placeholder="연락 가능한 전화번호" autocomplete="tel" required></td>
                        <th style="width: 80px;">이메일 <span class="required">*</span></th>
                        <td colspan="3"><input type="email" name="email" placeholder="결과 수령용 이메일 주소" autocomplete="email" required></td>
                    </tr>
                </table>
            </div>

            <!-- 분석 신청 내역 -->
            <div class="form-section">
                <div class="section-title">■ 신청 내역 (Request Details)</div>
                
                <!-- 분석 선택 -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                    <div>
                        <h5 style="margin: 5px 0; font-size: 12px; font-weight: bold; color: #005baa;">1. 기본 조직처리</h5>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="paraffin" name="services" value="paraffin">
                                <label for="paraffin">파라핀 포매</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="frozen" name="services" value="frozen">
                                <label for="frozen">동결절편</label>
                            </div>
                        </div>
                        
                        <h5 style="margin: 5px 0; font-size: 12px; font-weight: bold; color: #005baa;">2. 특수염색</h5>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="pas" name="services" value="pas">
                                <label for="pas">PAS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="masson" name="services" value="masson">
                                <label for="masson">Masson</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="alcian_blue" name="services" value="alcian_blue">
                                <label for="alcian_blue">Alcian Blue</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="pico_sirius_red" name="services" value="pico_sirius_red">
                                <label for="pico_sirius_red">Pico Sirius Red</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="oil_red_o" name="services" value="oil_red_o">
                                <label for="oil_red_o">Oil Red O</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other_special" name="services" value="other_special">
                                <label for="other_special">기타 특수염색</label>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h5 style="margin: 5px 0; font-size: 12px; font-weight: bold; color: #005baa;">3. 면역염색</h5>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="ihc" name="services" value="ihc">
                                <label for="ihc">IHC</label>
                            </div>
                            <div class="checkbox-item">
                                
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="if_staining" name="services" value="if_staining">
                                <label for="if_staining">IF</label>
                            </div>
                        </div>
                        
                        <h5 style="margin: 5px 0; font-size: 12px; font-weight: bold; color: #005baa;">4. 분자병리 & 기타</h5>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="fish" name="services" value="fish">
                                <label for="fish">FISH</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="dna_extraction" name="services" value="dna_extraction">
                                <label for="dna_extraction">DNA 추출</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="rna_extraction" name="services" value="rna_extraction">
                                <label for="rna_extraction">RNA 추출</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="tma" name="services" value="tma">
                                <label for="tma">TMA</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 서비스 상세 정보 테이블 -->
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>검체 수<br>(Sample Count)</th>
                            <th>의뢰 분석<br>(Analysis)</th>
                            <th>세부 분석<br>(Detail Analysis)</th>
                            <th>슬라이드 수<br>(Slide Count)</th>
                            <th>의뢰 총수량<br>(Total Count)</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                        <tr>
                            <td data-label="검체 수"><input type="number" name="sample_count_1" min="0" placeholder="0"></td>
                            <td data-label="의뢰 분석"><input type="text" name="service_name_1" placeholder="분석명"></td>
                            <td data-label="세부 분석"><input type="text" name="antibody_type_1" placeholder="세부분석" style="width: 100%; min-width: 200px;"></td>
                            <td data-label="슬라이드 수"><input type="number" name="slide_count_1" min="0" placeholder="0"></td>
                            <td data-label="의뢰 총수량"><input type="number" name="total_count_1" readonly></td>
                        </tr>
                        <tr>
                            <td data-label="검체 수"><input type="number" name="sample_count_2" min="0" placeholder="0"></td>
                            <td data-label="의뢰 분석"><input type="text" name="service_name_2" placeholder="분석명"></td>
                            <td data-label="세부 분석"><input type="text" name="antibody_type_2" placeholder="세부분석" style="width: 100%; min-width: 200px;"></td>
                            <td data-label="슬라이드 수"><input type="number" name="slide_count_2" min="0" placeholder="0"></td>
                            <td data-label="의뢰 총수량"><input type="number" name="total_count_2" readonly></td>
                        </tr>
                        <tr>
                            <td data-label="검체 수"><input type="number" name="sample_count_3" min="0" placeholder="0"></td>
                            <td data-label="의뢰 분석"><input type="text" name="service_name_3" placeholder="분석명"></td>
                            <td data-label="세부 분석"><input type="text" name="antibody_type_3" placeholder="세부분석" style="width: 100%; min-width: 200px;"></td>
                            <td data-label="슬라이드 수"><input type="number" name="slide_count_3" min="0" placeholder="0"></td>
                            <td data-label="의뢰 총수량"><input type="number" name="total_count_3" readonly></td>
                        </tr>
                        <tr>
                            <td data-label="검체 수"><input type="number" name="sample_count_4" min="0" placeholder="0"></td>      
                            <td data-label="의뢰 분석"><input type="text" name="service_name_4" placeholder="분석명"></td>
                        
                            <td data-label="세부 분석"><input type="text" name="antibody_type_4" placeholder="세부분석" style="width: 100%; min-width: 200px;"></td>
                            <td data-label="슬라이드 수"><input type="number" name="slide_count_4" min="0" placeholder="0"></td>
                            <td data-label="의뢰 총수량"><input type="number" name="total_count_4" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 검체 정보 -->
            <div class="form-section">
                <div class="section-title">■ 검체 정보 (Sample Information)</div>
                <table class="form-table">
                    <tr>
                        <th>검체명 (Sample Name) <span class="required">*</span></th>
                        <td><input type="text" name="sample_name" placeholder="검체명을 상세히 기재해주세요" autocomplete="off" required></td>
                    </tr>
                    <tr>
                        <th>검체 종류 (Sample Type)</th>
                        <td>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="tissue" name="sample_type" value="tissue">
                                    <label for="tissue">조직 (Tissue)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cell" name="sample_type" value="cell">
                                    <label for="cell">세포 (Cell)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="other_sample" name="sample_type" value="other">
                                    <label for="other_sample">기타</label>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>고정액 (Fixative)</th>
                        <td>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="nbf" name="fixative" value="nbf">
                                    <label for="nbf">10% NBF</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="alcohol" name="fixative" value="alcohol">
                                    <label for="alcohol">Alcohol</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="other_fixative" name="fixative" value="other">
                                    <label for="other_fixative">기타</label>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>특별 요청사항 (Special Requests)</th>
                        <td><textarea name="special_requests" placeholder="특별한 처리 방법이나 주의사항이 있으면 기재해주세요" autocomplete="off"></textarea></td>
                    </tr>
                </table>
            </div>

            <!-- 서명 -->
            <div class="signature-section">
                <p>위와 같이 분석을 신청합니다.</p>
                <p>신청일: <input type="date" name="signature_date" style="border:none; border-bottom:1px solid #000; background:transparent;"></p>
                
                <!-- 개선된 서명란 -->
                <div class="signature-container">
                    <p><strong>신청자 서명:</strong></p>
                    
                    <!-- 서명 방식 선택 -->
                    <div class="signature-method">
                        <label>
                            <input type="radio" name="signature_method" value="text" checked>
                            텍스트 서명
                        </label>
                        <label>
                            <input type="radio" name="signature_method" value="draw">
                            디지털 서명
                        </label>
            </div>

                    <!-- 텍스트 서명 -->
                    <div id="text-signature" class="signature-input">
                        <input type="text" name="signature_name" placeholder="성명을 입력하세요" required>
                        <div class="signature-confirm">
                            <label>
                                <input type="checkbox" name="signature_confirm" required>
                                위 내용이 사실임을 확인하며, <strong>「안재우」</strong>가 직접 서명합니다.
                            </label>
                        </div>
                    </div>
                    
                    <!-- 디지털 서명 패드 -->
                    <div id="draw-signature" class="signature-input" style="display: none;">
                        <canvas id="signature-pad" width="400" height="150" style="border: 1px solid #ccc; background: white;"></canvas>
                        <div class="signature-controls">
                            <button type="button" id="clear-signature">지우기</button>
                            <button type="button" id="save-signature">서명 완료</button>
                        </div>
                        <input type="hidden" name="signature_data" id="signature-data">
                    </div>
                </div>
                
                <!-- reCAPTCHA 위젯 -->
                <div id="recaptcha-container" style="margin-top: 20px; text-align: center; display: flex; justify-content: center;">
                    <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"></div>
                </div>
                
                <!-- 제출 버튼 (PDF 캡처 시 숨김 처리) -->
                <div class="submit-section" id="submit-section" style="margin-top: 30px; text-align: center;">
                    <button type="button" id="submit-application" class="submit-btn" style="background: linear-gradient(45deg, #28a745, #007bff); color: white; padding: 20px 50px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        신청서 제출
                    </button>
                    
                                         <div style="margin-top: 10px; font-size: 12px; color: #666;">
                         📧 신청서가 이메일로 발송됩니다.
                     </div>
                </div>
            </div>

        </form>

        <div class="form-footer">
            <p><strong>부산대학교 의과대학 조직병리코어센터</strong></p>
            <p>주소: (50612)경상남도 양산시 물금읍 부산대학로 49, 부산대학교 양산캠퍼스 첨단의생명융합센터 202호</p>
            <p>전화: 051-510-8057, 8525 | 이메일: histopath.pnu@gmail.com</p>
        </div>

        
    </div>

    <script>
        // 총 수량 자동 계산
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('#servicesTableBody tr');
            
            rows.forEach((row, index) => {
                const sampleInput = row.querySelector(`input[name="sample_count_${index + 1}"]`);
                const slideInput = row.querySelector(`input[name="slide_count_${index + 1}"]`);
                const totalInput = row.querySelector(`input[name="total_count_${index + 1}"]`);
                
                if (sampleInput && slideInput && totalInput) {
                    function calculateTotal() {
                        const sampleCount = parseInt(sampleInput.value) || 0;
                        const slideCount = parseInt(slideInput.value) || 0;
                        totalInput.value = sampleCount * slideCount;
                    }
                    
                    sampleInput.addEventListener('input', calculateTotal);
                    slideInput.addEventListener('input', calculateTotal);
                }
            });
            
            // 오늘 날짜 자동 입력
            const today = new Date().toISOString().split('T')[0];
            const applicationDateInput = document.querySelector('input[name="application_date"]');
            if (applicationDateInput) {
            applicationDateInput.value = today;
            }
            const signatureDateInput = document.querySelector('input[name="signature_date"]');
            if (signatureDateInput) {
                signatureDateInput.value = today;
            }
            
            // 접수번호 자동 생성
            generateReceiptNumber(today);
            
            // 신청일이 변경될 때마다 접수번호 재생성
            applicationDateInput.addEventListener('change', function() {
                generateReceiptNumber(this.value);
            });
            
            // URL 파라미터에서 데이터 가져와서 자동 입력
            loadDataFromURL();
            
            // 서명 시스템 초기화
            initSignatureSystem();
        });

        // 🔒 중복 방지 접수번호 자동 생성 함수 (실제 운영용)
        function generateReceiptNumber(dateString) {
            if (!dateString) return;
            
            // 날짜를 YYMMDD 형식으로 변환
            const date = new Date(dateString);
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const datePrefix = year + month + day;
            
            // 📍 방법 1: 타임스탬프 기반 고유 번호 생성
            const now = new Date();
            const timestamp = now.getTime(); // 밀리초 단위 타임스탬프
            const timeString = now.getHours().toString().padStart(2, '0') + 
                             now.getMinutes().toString().padStart(2, '0') + 
                             now.getSeconds().toString().padStart(2, '0');
            
            // 📍 방법 2: 브라우저 고유 식별자 생성 (세션별 구분)
            let sessionId = localStorage.getItem('browserSessionId');
            if (!sessionId) {
                // 랜덤 3자리 + 현재 시간 조합으로 세션 ID 생성
                sessionId = Math.floor(Math.random() * 900 + 100).toString() + 
                           (timestamp % 1000).toString().padStart(3, '0');
                localStorage.setItem('browserSessionId', sessionId);
            }
            
            // 📍 방법 3: 연속적 카운터 관리 (날짜가 바뀌어도 계속 증가)
            const globalCounterKey = 'globalReceiptCounter';
            let globalCounter = parseInt(localStorage.getItem(globalCounterKey) || '0') + 1;
            localStorage.setItem(globalCounterKey, globalCounter.toString());
            
            // 📍 방법 4: 하이브리드 고유 번호 생성
            // 내부용: YYMMDD-HHMMSS-XXX (시분초 포함으로 중복 방지)
            const internalReceiptNumber = datePrefix + '-' + timeString + '-' + globalCounter.toString().padStart(3, '0');
            
            // 📍 방법 5: 중복 검증 및 재생성
            const usedNumbers = JSON.parse(localStorage.getItem('usedReceiptNumbers') || '[]');
            let finalInternalNumber = internalReceiptNumber;
            let attempt = 0;
            
            while (usedNumbers.includes(finalInternalNumber) && attempt < 10) {
                attempt++;
                finalInternalNumber = datePrefix + '-' + timeString + '-' + (globalCounter + attempt).toString().padStart(3, '0');
            }
            
            // 사용된 번호 목록에 추가 (최근 1000개만 보관)
            usedNumbers.push(finalInternalNumber);
            if (usedNumbers.length > 1000) {
                usedNumbers.splice(0, usedNumbers.length - 1000);
            }
            localStorage.setItem('usedReceiptNumbers', JSON.stringify(usedNumbers));
            
            // 📍 방법 6: 사용자용 간단한 표시 번호 생성
            // 표시용: YYMMDD-XXX (간단하고 보기 좋게)
            const displayReceiptNumber = datePrefix + '-' + (globalCounter + attempt).toString().padStart(3, '0');
            
            // 접수번호 입력란에 표시용 번호 설정
            const receiptInput = document.getElementById('receipt_number_top');
            if (receiptInput) {
                receiptInput.value = displayReceiptNumber;
                // 내부 처리용 전체 번호는 데이터 속성에 저장
                receiptInput.setAttribute('data-internal-number', finalInternalNumber);
            }
            
            console.log('👁️ 사용자 표시 번호:', displayReceiptNumber);
            console.log('🔒 내부 처리 번호:', finalInternalNumber);
            console.log('📊 브라우저 세션 ID:', sessionId);
            console.log('📈 연속 카운터:', globalCounter);
        }

        // URL 파라미터에서 데이터 로드하여 폼에 자동 입력
        function loadDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            
            console.log('URL 파라미터:', window.location.search);
            
            // 개별 파라미터들을 직접 읽어서 폼에 입력
            const name = urlParams.get('name');
            const institution = urlParams.get('institution');
            const department = urlParams.get('department');
            const email = urlParams.get('email');
            const phone = urlParams.get('phone');
            const sampleName = urlParams.get('sampleName');
            const specialRequests = urlParams.get('specialRequests');
            const sampleType = urlParams.get('sampleType');
            const fixative = urlParams.get('fixative');
                
                // 신청자 정보 자동 입력
            if (name) {
                const nameInput = document.querySelector('input[name="applicant_name"]');
                if (nameInput) {
                    nameInput.value = decodeURIComponent(name);
                    console.log('이름 입력:', decodeURIComponent(name));
                }
            }
            if (institution) {
                const institutionInput = document.querySelector('input[name="institution"]');
                if (institutionInput) {
                    institutionInput.value = decodeURIComponent(institution);
                    console.log('소속기관 입력:', decodeURIComponent(institution));
                }
            }
            if (department) {
                const departmentInput = document.querySelector('input[name="department"]');
                if (departmentInput) {
                    departmentInput.value = decodeURIComponent(department);
                    console.log('부서 입력:', decodeURIComponent(department));
                }
            }
            if (email) {
                const emailInput = document.querySelector('input[name="email"]');
                if (emailInput) {
                    emailInput.value = decodeURIComponent(email);
                    console.log('이메일 입력:', decodeURIComponent(email));
                }
            }
            if (phone) {
                const phoneInput = document.querySelector('input[name="phone"]');
                if (phoneInput) {
                    phoneInput.value = decodeURIComponent(phone);
                    console.log('전화번호 입력:', decodeURIComponent(phone));
                }
            }
            if (sampleName) {
                const sampleNameInput = document.querySelector('input[name="sample_name"]');
                if (sampleNameInput) {
                    sampleNameInput.value = decodeURIComponent(sampleName);
                    console.log('검체명 입력:', decodeURIComponent(sampleName));
                }
            }
            if (specialRequests) {
                const specialRequestsInput = document.querySelector('textarea[name="special_requests"]');
                if (specialRequestsInput) {
                    specialRequestsInput.value = decodeURIComponent(specialRequests);
                    console.log('특별요청사항 입력:', decodeURIComponent(specialRequests));
                }
                }
                
                // 검체 종류 자동 선택
            if (sampleType) {
                console.log('검체 종류:', sampleType);
                if (sampleType === 'tissue') {
                            const checkbox = document.getElementById('tissue');
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('조직 체크박스 선택됨');
                    }
                } else if (sampleType === 'cell') {
                            const checkbox = document.getElementById('cell');
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('세포 체크박스 선택됨');
                    }
                }
                }
                
                // 고정액 자동 선택
            if (fixative) {
                console.log('고정액:', fixative);
                if (fixative === 'nbf') {
                            const checkbox = document.getElementById('nbf');
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('NBF 체크박스 선택됨');
                    }
                } else if (fixative === 'alcohol') {
                            const checkbox = document.getElementById('alcohol');
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('Alcohol 체크박스 선택됨');
                    }
                }
            }
            
            // 서비스 자동 선택 및 테이블 자동 입력
            const services = urlParams.get('services');
            if (services) {
                console.log('서비스 파라미터 발견:', services);
                

                
                // 서비스 테이블 자동 입력
                fillServiceTableWithBasicData();
            }
            
            // 서비스 테이블 자동 입력 함수 (이전 작동 방식으로 복원)
            function fillServiceTableWithBasicData() {
                console.log('서비스 테이블 자동 입력 시작');
                
                // 첫 번째 행: 면역조직화학염색 (IHC)
                const row1SampleCount = document.querySelector('input[name="sample_count_1"]');
                const row1ServiceName = document.querySelector('input[name="service_name_1"]');
                const row1AntibodyType = document.querySelector('input[name="antibody_type_1"]');
                const row1SlideCount = document.querySelector('input[name="slide_count_1"]');
                const row1TotalCount = document.querySelector('input[name="total_count_1"]');
                
                if (row1SampleCount) {
                    row1SampleCount.value = '1';
                    console.log('검체수 1 입력: 1');
                }
                
                if (row1ServiceName) {
                                    row1ServiceName.value = '면역조직화학염색 (IHC)';
                console.log('의뢰분석 1 입력: 면역조직화학염색 (IHC)');
                }
                
                if (row1AntibodyType) {
                    row1AntibodyType.value = '단일 마커';
                    console.log('세부분석 1 입력: 단일 마커');
                }
                
                if (row1SlideCount) {
                    row1SlideCount.value = '1';
                    console.log('슬라이드수 1 입력: 1');
                }
                
                if (row1TotalCount) {
                    row1TotalCount.value = '1';
                    console.log('의뢰총수량 1 입력: 1');
                }
                
                console.log('면역조직화학염색 (IHC) 서비스가 자동 입력되었습니다!');
            }
            
            // 🆕 URL에서 테이블 데이터 자동 입력
            loadTableDataFromURL(urlParams);
            
            // 🆕 체크박스 자동 선택 처리
            autoSelectCheckboxesFromURL(urlParams);
            
            // 자동 입력 완료 메시지 표시 (파라미터가 있을 때만)
            if (name || institution || department || email || phone || sampleName || specialRequests) {
                showAutoFillMessage();
            }
        }
        
        // 🆕 URL에서 테이블 데이터 자동 입력 함수
        function loadTableDataFromURL(urlParams) {
            console.log('🔄 테이블 데이터 자동 입력 시작');
            
            // 최대 4개 행까지 처리
            for (let i = 1; i <= 4; i++) {
                const sampleCount = urlParams.get(`sample_count_${i}`);
                const serviceName = urlParams.get(`service_name_${i}`);
                const antibodyType = urlParams.get(`antibody_type_${i}`);
                const slideCount = urlParams.get(`slide_count_${i}`);
                const totalCount = urlParams.get(`total_count_${i}`);
                
                // 해당 행에 데이터가 있는 경우에만 입력
                if (sampleCount || serviceName || antibodyType || slideCount || totalCount) {
                    console.log(`📝 행 ${i} 데이터 발견:`, {sampleCount, serviceName, antibodyType, slideCount, totalCount});
                    
                    // 각 필드에 데이터 입력
                    if (sampleCount) {
                        const input = document.querySelector(`input[name="sample_count_${i}"]`);
                        if (input) {
                            input.value = decodeURIComponent(sampleCount);
                            console.log(`✅ 검체수 ${i}: ${decodeURIComponent(sampleCount)}`);
                        }
                    }
                    
                    if (serviceName) {
                        const input = document.querySelector(`input[name="service_name_${i}"]`);
                        if (input) {
                            input.value = decodeURIComponent(serviceName);
                            console.log(`✅ 서비스명 ${i}: ${decodeURIComponent(serviceName)}`);
                        }
                    }
                    
                    if (antibodyType) {
                        const input = document.querySelector(`input[name="antibody_type_${i}"]`);
                        if (input) {
                            let processedValue = decodeURIComponent(antibodyType);
                            
                            // MT 축약
                            processedValue = processedValue
                                .replace(/MT - \(Masson's Trichrome\)/gi, 'MT');
                            
                            input.value = processedValue;
                            console.log(`✅ 세부분석 ${i}: ${processedValue}`);
                        }
                    }
                    
                    if (slideCount) {
                        const input = document.querySelector(`input[name="slide_count_${i}"]`);
                        if (input) {
                            input.value = decodeURIComponent(slideCount);
                            console.log(`✅ 슬라이드수 ${i}: ${decodeURIComponent(slideCount)}`);
                        }
                    }
                    
                    if (totalCount) {
                        const input = document.querySelector(`input[name="total_count_${i}"]`);
                        if (input) {
                            input.value = decodeURIComponent(totalCount);
                            console.log(`✅ 총수량 ${i}: ${decodeURIComponent(totalCount)}`);
                        }
                    }
                }
            }
            
            console.log('✅ 테이블 데이터 자동 입력 완료');
        }
        
        // 🆕 URL에서 체크박스 자동 선택 함수
        function autoSelectCheckboxesFromURL(urlParams) {
            console.log('🔄 체크박스 자동 선택 시작');
            
            // 검체 종류 체크박스들
            const sampleTypes = ['tissue', 'cell', 'other'];
            sampleTypes.forEach(type => {
                const param = urlParams.get(`sample_type_${type}`);
                if (param === 'on' || param === 'true' || param === '1') {
                    const checkbox = document.getElementById(type);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✅ 검체 종류 ${type} 선택됨`);
                    }
                }
            });
            
            // 고정액 체크박스들 
            const fixatives = ['nbf', 'alcohol', 'other'];
            fixatives.forEach(fixative => {
                const param = urlParams.get(`fixative_${fixative}`);
                if (param === 'on' || param === 'true' || param === '1') {
                    const checkbox = document.getElementById(fixative);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✅ 고정액 ${fixative} 선택됨`);
                    }
                }
            });
            
            // 🎯 특수염색 자동감지 및 체크박스 선택 (약간 지연)
            setTimeout(() => {
                autoDetectSpecialStainingFromTableData(urlParams);
            }, 100);
            
            // 기본 분석 체크박스들
            const analyses = ['paraffin', 'frozen', 'pas', 'masson', 'alcian_blue', 'pico_sirius_red', 
                            'ihc', 'if_staining', 'fish', 'dna_extraction', 'rna_extraction', 'tma'];
            analyses.forEach(analysis => {
                const param = urlParams.get(analysis);
                if (param === 'on' || param === 'true' || param === '1') {
                    const checkbox = document.getElementById(analysis);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✅ 분석 ${analysis} 선택됨`);
                    }
                }
            });
            
            console.log('✅ 체크박스 자동 선택 완료');
        }
        
        // 🎯 특수염색 자동감지 및 체크박스 선택 함수
        function autoDetectSpecialStainingFromTableData(urlParams) {
            console.log('🔍 특수염색 자동감지 시작');
            console.log('🔍 전달받은 URL 파라미터들:', Array.from(urlParams.entries()));
            
            let hasSpecialStaining = false;
            let detectedStains = [];
            
            // 테이블 데이터에서 특수염색 항목 감지
            for (let i = 1; i <= 4; i++) {
                const serviceName = urlParams.get(`service_name_${i}`);
                const antibodyType = urlParams.get(`antibody_type_${i}`);
                
                if (serviceName || antibodyType) {
                    const serviceText = decodeURIComponent(serviceName || '').toLowerCase();
                    const antibodyText = decodeURIComponent(antibodyType || '').toLowerCase();
                    const combinedText = `${serviceText} ${antibodyText}`.toLowerCase();
                    
                    console.log(`📋 행 ${i} 검사:`, {serviceName, antibodyType, combinedText});
                    
                    // 특수염색 종류별 감지
                    if (combinedText.includes('pas') || combinedText.includes('periodic acid') || combinedText.includes('PAS')) {
                        if (!detectedStains.includes('pas')) {
                            detectedStains.push('pas');
                            hasSpecialStaining = true;
                            console.log('🎯 PAS 염색 감지됨');
                        }
                    }
                    
                    if (combinedText.includes('mt -') || combinedText.includes('masson') || combinedText.includes('trichrome') || combinedText.includes('mt')) {
                        if (!detectedStains.includes('masson')) {
                            detectedStains.push('masson');
                            hasSpecialStaining = true;
                            console.log('🎯 Masson Trichrome 염색 감지됨');
                        }
                    }
                    
                    if (combinedText.includes('alcian') || combinedText.includes('alcian blue')) {
                        if (!detectedStains.includes('alcian_blue')) {
                            detectedStains.push('alcian_blue');
                            hasSpecialStaining = true;
                            console.log('🎯 Alcian Blue 염색 감지됨');
                        }
                    }
                    
                    if (combinedText.includes('pico') || combinedText.includes('sirius') || combinedText.includes('picro sirius') || combinedText.includes('sirius red') || combinedText.includes('pico sirius')) {
                        if (!detectedStains.includes('pico_sirius_red')) {
                            detectedStains.push('pico_sirius_red');
                            hasSpecialStaining = true;
                            console.log('🎯 Pico Sirius Red 염색 감지됨');
                        }
                    }
                    
                    if (combinedText.includes('oil red') || combinedText.includes('오일레드') || combinedText.includes('oil_red')) {
                        if (!detectedStains.includes('oil_red_o')) {
                            detectedStains.push('oil_red_o');
                            hasSpecialStaining = true;
                            console.log('🎯 Oil Red O 염색 감지됨');
                        }
                    }
                    
                    // 메인페이지에서 "기타(문의가능)" 선택 시 기타 특수염색 체크박스 자동 선택
                    if (combinedText.includes('기타') || combinedText.includes('문의가능') || combinedText.includes('기타(문의가능)')) {
                        if (!detectedStains.includes('other_special')) {
                            detectedStains.push('other_special');
                            hasSpecialStaining = true;
                            console.log('🎯 기타(문의가능) 특수염색 감지됨');
                        }
                    }
                    
                    // 특수염색 일반 감지 (세부 정보가 있는 경우만)
                    if (combinedText.includes('특수염색') || combinedText.includes('special stain') || 
                        combinedText.includes('only special') || serviceName === '특수염색') {
                        hasSpecialStaining = true;
                        console.log('🎯 일반 특수염색 감지됨');
                        
                        // 세부분석에 구체적인 정보가 있는 경우만 처리
                        // 단순히 "특수염색"만 있는 경우에는 자동으로 체크박스를 선택하지 않음
                        console.log('ℹ️ 특수염색이 감지되었지만 구체적인 종류가 명시되지 않음');
                    }
                    
                    // 면역염색 감지
                    if (combinedText.includes('ihc') || combinedText.includes('면역조직화학')) {
                        detectedStains.push('ihc');
                        console.log('🎯 IHC 염색 감지됨');
                    }
                    
                    
                    
                    if (combinedText.includes('if') || combinedText.includes('면역형광') || combinedText.includes('immunofluorescence')) {
                        detectedStains.push('if_staining');
                        console.log('🎯 IF 염색 감지됨');
                    }
                    
                    if (combinedText.includes('fish') || combinedText.includes('형광제자리부합')) {
                        detectedStains.push('fish');
                        console.log('🎯 FISH 감지됨');
                    }
                }
            }
            
            // 감지된 특수염색 체크박스들 자동 선택
            console.log('📝 체크박스 선택 시도 - 감지된 염색 수:', detectedStains.length);
            console.log('📝 감지된 염색 종류들:', detectedStains);
            
            if (detectedStains.length > 0) {
                detectedStains.forEach(stainType => {
                    console.log(`🔍 ${stainType} 체크박스 찾는 중...`);
                    const checkbox = document.getElementById(stainType);
                    console.log(`🔍 ${stainType} 체크박스 요소:`, checkbox);
                    
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✅ ${stainType} 체크박스 자동 선택됨 - checked:`, checkbox.checked);
                        
                        // 이벤트 트리거하여 다른 스크립트에 알림
                        try {
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        } catch (e) {
                            // 이벤트 발생 실패 시 무시
                        }
                    } else {
                        // 체크박스를 찾을 수 없는 경우 (일반적인 상황이므로 에러가 아님)
                        console.log(`ℹ️ ${stainType} 체크박스를 찾을 수 없음 (정상적인 상황일 수 있음)`);
                    }
                });
            } else {
                console.log('⚠️ 감지된 특수염색이 없습니다');
            }
            
            if (hasSpecialStaining) {
                console.log('🎯 특수염색 감지됨 - 관련 체크박스들이 자동 선택됩니다');
            } else {
                console.log('ℹ️ 특수염색이 감지되지 않았습니다');
            }
        }

                 // 서비스별 체크박스 자동 선택
         function autoSelectServiceCheckboxes(services) {
             const serviceMapping = {
                 '파라핀 포매': 'paraffin',
                 '동결절편': 'frozen',
                 // '특수염색': 'pas', // 특수염색은 autoDetectSpecialStainingFromTableData 함수에서 자동 감지
                 '면역조직화학염색 (IHC)': 'ihc',
                 '면역형광염색 (IF)': 'if_staining',
                 '형광제자리부합법 (FISH)': 'fish',
                 'Tissue Microarray (TMA)': 'tma',
                 'DNA/RNA 추출': 'dna_extraction',
                 'Alcian Blue 염색': 'alcian_blue',
                 'Pico Sirius Red 염색': 'pico_sirius_red'
             };

            services.forEach(service => {
                const checkboxId = serviceMapping[service.mainService];
                if (checkboxId) {
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                }
            });
        }

        // 서비스 테이블에 데이터 자동 입력
        function fillServiceTable(services) {
            const tableBody = document.getElementById('servicesTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            services.forEach((service, index) => {
                if (index < rows.length) {
                    const row = rows[index];
                    
                    // 검체 수
                    const sampleCountInput = row.querySelector(`input[name="sample_count_${index + 1}"]`);
                    if (sampleCountInput) {
                        sampleCountInput.value = service.sampleCount;
                    }
                    
                    // 서비스명
                    const serviceNameInput = row.querySelector(`input[name="service_name_${index + 1}"]`);
                    if (serviceNameInput) {
                        serviceNameInput.value = service.mainService;
                    }
                    
                    // 세부 서비스
                    const antibodyTypeInput = row.querySelector(`input[name="antibody_type_${index + 1}"]`);
                    if (antibodyTypeInput && service.subService) {
                        antibodyTypeInput.value = service.subService;
                    }
                    
                    // 슬라이드 수
                    const slideCountInput = row.querySelector(`input[name="slide_count_${index + 1}"]`);
                    if (slideCountInput) {
                        slideCountInput.value = service.slideCount;
                    }
                    
                    // 총 수량 (자동 계산)
                    const totalCountInput = row.querySelector(`input[name="total_count_${index + 1}"]`);
                    if (totalCountInput) {
                        totalCountInput.value = service.totalCount || (parseInt(service.sampleCount) * parseInt(service.slideCount));
                    }
                }
            });
        }

        // 자동 입력 완료 메시지 표시
        function showAutoFillMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 14px;
            `;
            message.innerHTML = '✅ 온라인 신청 내용이 자동으로 입력되었습니다!';
            
            document.body.appendChild(message);
            
            // 3초 후 메시지 제거
            setTimeout(() => {
                document.body.removeChild(message);
            }, 3000);
        }

        // 서명 시스템 초기화
        function initSignatureSystem() {
            const textSignatureDiv = document.getElementById('text-signature');
            const drawSignatureDiv = document.getElementById('draw-signature');
            const signatureMethodRadios = document.querySelectorAll('input[name="signature_method"]');
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            // 서명 방식 변경 이벤트
            signatureMethodRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'text') {
                        textSignatureDiv.style.display = 'block';
                        drawSignatureDiv.style.display = 'none';
                    } else {
                        textSignatureDiv.style.display = 'none';
                        drawSignatureDiv.style.display = 'block';
                    }
                });
            });

            // 신청자 이름 자동 입력 시 서명 확인란 업데이트
            const signatureNameInput = document.querySelector('input[name="signature_name"]');
            const signatureConfirmLabel = document.querySelector('.signature-confirm label');
            
            if (signatureNameInput && signatureConfirmLabel) {
                signatureNameInput.addEventListener('input', function() {
                    const name = this.value || '신청자';
                    signatureConfirmLabel.innerHTML = `
                        <input type="checkbox" name="signature_confirm" required>
                        위 내용이 사실임을 확인하며, <strong>「${name}」</strong>가 직접 서명합니다.
                    `;
                });
            }

            // 디지털 서명 패드 기능
            if (canvas) {
                // 마우스 이벤트
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                // 터치 이벤트 (모바일)
                canvas.addEventListener('touchstart', handleTouch);
                canvas.addEventListener('touchmove', handleTouch);
                canvas.addEventListener('touchend', stopDrawing);

                function startDrawing(e) {
                    isDrawing = true;
                    draw(e);
                }

                function draw(e) {
                    if (!isDrawing) return;

                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = '#000';

                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                }

                function stopDrawing() {
                    if (isDrawing) {
                        isDrawing = false;
                        ctx.beginPath();
                        // 서명 데이터를 hidden input에 저장
                        document.getElementById('signature-data').value = canvas.toDataURL();
                    }
                }

                function handleTouch(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                     e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    canvas.dispatchEvent(mouseEvent);
                }

                // 서명 지우기
                document.getElementById('clear-signature').addEventListener('click', function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    document.getElementById('signature-data').value = '';
                });

                // 서명 완료
                document.getElementById('save-signature').addEventListener('click', function() {
                    if (document.getElementById('signature-data').value) {
                        alert('서명이 저장되었습니다.');
                    } else {
                        alert('서명을 먼저 작성해주세요.');
                    }
                });
            }

            // 신청서 제출 버튼 이벤트
            document.getElementById('submit-application').addEventListener('click', function() {
                // Rate Limiting 검증
                if (!checkRateLimit()) {
                    return;
                }
                
                // 입력값 보안 검증
                if (!validateAllInputs()) {
                    return;
                }
                
                // reCAPTCHA 검증
                try {
                    const recaptchaResponse = grecaptcha.getResponse();
                    if (!recaptchaResponse || recaptchaResponse.length === 0) {
                        alert('🤖 로봇이 아닙니다 인증을 완료해주세요.\n\n아래 체크박스를 클릭하여 인증해주세요.');
                        
                        // reCAPTCHA 위젯으로 스크롤
                        document.getElementById('recaptcha-container').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        return;
                    }
                    console.log('✅ reCAPTCHA 검증 통과');
                } catch (error) {
                    console.warn('⚠️ reCAPTCHA 검증 오류:', error);
                    alert('🤖 로봇이 아닙니다 인증을 완료해주세요.\n\n페이지를 새로고침 후 다시 시도해주세요.');
                    return;
                }
                
                if (validateSignature()) {
                    submitApplication();
                }
            });
            
            
        }

        // 🔒 XSS 방지 입력 검증 함수
        function sanitizeInput(input) {
            if (typeof input !== 'string') {
                return input;
            }
            
            // 기본 HTML 태그 제거
            let sanitized = input.replace(/<[^>]*>/g, '');
            
            // 스크립트 관련 키워드 제거
            const dangerousPatterns = [
                /javascript:/gi,
                /vbscript:/gi,
                /onload=/gi,
                /onerror=/gi,
                /onclick=/gi,
                /onmouseover=/gi,
                /onfocus=/gi,
                /onblur=/gi,
                /onchange=/gi,
                /onsubmit=/gi,
                /<script/gi,
                /<\/script>/gi,
                /eval\(/gi,
                /alert\(/gi,
                /confirm\(/gi,
                /prompt\(/gi
            ];
            
            dangerousPatterns.forEach(pattern => {
                sanitized = sanitized.replace(pattern, '');
            });
            
            // HTML 엔티티 인코딩
            sanitized = sanitized
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
            
            return sanitized;
        }

        // 🔒 모든 입력값 검증 함수
        function validateAllInputs() {
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea');
            let hasUnsafeInput = false;
            
            inputs.forEach(input => {
                const originalValue = input.value;
                const sanitizedValue = sanitizeInput(originalValue);
                
                // 값이 변경되었다면 위험한 입력이 있었다는 의미
                if (originalValue !== sanitizedValue) {
                    hasUnsafeInput = true;
                    console.warn('⚠️ 위험한 입력 감지:', {
                        field: input.name || input.id,
                        original: originalValue,
                        sanitized: sanitizedValue
                    });
                }
            });
            
            if (hasUnsafeInput) {
                alert(`🚫 보안 위험 입력 감지
                
입력한 내용에 보안상 위험한 문자가 포함되어 있습니다.
HTML 태그나 스크립트 코드는 사용할 수 없습니다.

일반적인 텍스트만 입력해주세요.`);
                return false;
            }
            
            return true;
        }

        // 🔒 Rate Limiting 검증 함수
        function checkRateLimit() {
            const MAX_ATTEMPTS = 3;
            const TIME_WINDOW = 5 * 60 * 1000; // 5분
            const STORAGE_KEY = 'submission_attempts';
            
            try {
                // 현재 시간
                const now = Date.now();
                
                // 저장된 시도 기록 가져오기
                const storedAttempts = localStorage.getItem(STORAGE_KEY);
                let attempts = storedAttempts ? JSON.parse(storedAttempts) : [];
                
                // 5분 이전 기록 제거
                attempts = attempts.filter(timestamp => now - timestamp < TIME_WINDOW);
                
                // 제한 확인
                if (attempts.length >= MAX_ATTEMPTS) {
                    const oldestAttempt = Math.min(...attempts);
                    const remainingTime = TIME_WINDOW - (now - oldestAttempt);
                    const remainingMinutes = Math.ceil(remainingTime / 60000);
                    
                    alert(`🚫 제출 제한 초과
                    
5분 동안 최대 ${MAX_ATTEMPTS}회까지만 제출할 수 있습니다.
${remainingMinutes}분 후에 다시 시도해주세요.

이 제한은 스팸 방지를 위한 보안 기능입니다.`);
                    return false;
                }
                
                // 현재 시도 기록 추가
                attempts.push(now);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(attempts));
                
                console.log(`✅ Rate Limit 통과: ${attempts.length}/${MAX_ATTEMPTS} 시도`);
                return true;
                
            } catch (error) {
                console.warn('⚠️ Rate Limit 검증 오류:', error);
                // 오류 발생 시 통과 처리 (관대한 처리)
                return true;
            }
        }

        // 서명 검증
        function validateSignature() {
            const signatureMethod = document.querySelector('input[name="signature_method"]:checked').value;
            
            if (signatureMethod === 'text') {
                const signatureName = document.querySelector('input[name="signature_name"]').value;
                const signatureConfirm = document.querySelector('input[name="signature_confirm"]').checked;
                
                if (!signatureName) {
                    alert('성명을 입력해주세요.');
                    return false;
                }
                if (!signatureConfirm) {
                    alert('서명 확인란에 체크해주세요.');
                    return false;
                }
            } else {
                const signatureData = document.getElementById('signature-data').value;
                if (!signatureData) {
                    alert('디지털 서명을 작성해주세요.');
                    return false;
                }
            }
            
            return true;
        }

        // 📸 신청서 이미지 생성 (html2canvas 사용)
        function generateApplicationImage() {
            return new Promise((resolve, reject) => {
                console.log('🎯 [자동화 시스템] 이미지 생성 시작');
                console.log('📸 신청서 이미지 생성 시작...');
                
                // html2canvas 라이브러리 동적 로드
                if (typeof html2canvas === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    script.onload = function() {
                        generateImageWithHtml2Canvas(resolve, reject);
                    };
                    script.onerror = function() {
                        console.log('📸 html2canvas 로드 실패, 폴백 이미지 생성');
                        const fallbackImage = generateFallbackApplicationImage();
                        resolve(fallbackImage);
                    };
                    document.head.appendChild(script);
                } else {
                    generateImageWithHtml2Canvas(resolve, reject);
                }
            });
        }

        // 📸 신청서 JPG 이미지 생성 (이메일 첨부용)
        function generateApplicationImageAsJPG() {
            return new Promise((resolve, reject) => {
                console.log('🎯 [자동화 시스템] JPG 이미지 생성 시작');
                console.log('📸 신청서 JPG 이미지 생성 시작...');
                
                // html2canvas 라이브러리 동적 로드
                if (typeof html2canvas === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    script.onload = function() {
                        generateJPGImageWithHtml2Canvas(resolve, reject);
                    };
                    script.onerror = function() {
                        console.log('📸 html2canvas 로드 실패');
                        reject(new Error('html2canvas 로드 실패'));
                    };
                    document.head.appendChild(script);
                } else {
                    generateJPGImageWithHtml2Canvas(resolve, reject);
                }
            });
        }

        // JPG 이미지 생성 실행 (html2canvas 사용)
        async function generateJPGImageWithHtml2Canvas(resolve, reject) {
            try {
                console.log('🖼️ html2canvas로 원래 크기 JPG 이미지 캡처 시작...');
                console.log('🔍 html2canvas 라이브러리 상태:', typeof html2canvas);
                
                // A4 세로 비율에 맞게 신청서 폼만 캡처
                const formElement = document.querySelector('.application-form');
                
                if (!formElement) {
                    console.error('❌ .application-form 요소를 찾을 수 없습니다!');
                    reject(new Error('신청서 폼 요소를 찾을 수 없습니다'));
                    return;
                }
                
                console.log('📋 A4 세로 비율 신청서 폼 캡처 모드');
                
                console.log('📋 캡처 대상:', formElement.tagName, formElement.offsetWidth, formElement.offsetHeight);
                
                // 폰트 로딩 완료 대기
                if (document.fonts && document.fonts.ready) {
                    await document.fonts.ready;
                    console.log('📝 폰트 로딩 완료');
                }
                
                // 🎯 렌더링 완료 대기 (더 오래)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 🎯 동적 요소들이 모두 로드될 때까지 추가 대기
                const allImages = formElement.querySelectorAll('img');
                await Promise.all(Array.from(allImages).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = img.onerror = resolve;
                    });
                }));
                
                // 🎯 스크롤을 맨 위로 이동하여 전체 캡처 준비
                window.scrollTo(0, 0);
                formElement.scrollTop = 0;
                
                // 🎯 최종 레이아웃 안정화 대기
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 🎯 원래 캡처 방식으로 복구
                const optimalScale = 1; // 원래 크기로 캡처
                
                console.log('📏 A4 세로 비율 신청서 폼 캡처 설정:', {
                    formWidth: formElement.scrollWidth,
                    formHeight: formElement.scrollHeight,
                    optimalScale: 2
                });

                // A4 세로 비율 고화질 신청서 폼 캡처 html2canvas 설정
                const html2canvasOptions = {
                    allowTaint: true,
                    useCORS: true,
                    scale: 2, // 고화질을 위해 2배 스케일
                    pixelRatio: window.devicePixelRatio || 1,
                    backgroundColor: '#ffffff',
                    logging: true,
                    removeContainer: true,
                    imageTimeout: 30000,
                    letterRendering: true,
                    foreignObjectRendering: false,
                    width: formElement.scrollWidth,
                    height: formElement.scrollHeight,
                    scrollX: 0,
                    scrollY: 0,
                    onclone: function(clonedDoc) {
                        // 원래 텍스트 설정으로 복구
                        const clonedInputs = clonedDoc.querySelectorAll('input, textarea, select');
                        clonedInputs.forEach(input => {
                            input.style.fontSize = '13px'; // 가독성을 위해 조금 더 크게
                            input.style.fontWeight = '500';
                            input.style.color = '#000';
                            input.style.lineHeight = '1.3';
                            input.style.padding = '3px 5px';
                        });
                        
                        const clonedCells = clonedDoc.querySelectorAll('td, th');
                        clonedCells.forEach(cell => {
                            cell.style.fontSize = '12px'; // 가독성을 위해 조금 더 크게
                            cell.style.fontWeight = '500';
                            cell.style.color = '#000';
                            cell.style.padding = '4px 6px';
                            cell.style.lineHeight = '1.2';
                        });
                        
                        // 원래 제목 및 라벨 설정으로 복구
                        const clonedLabels = clonedDoc.querySelectorAll('label, .form-label, h3, h4');
                        clonedLabels.forEach(label => {
                            label.style.fontSize = '13px';
                            label.style.fontWeight = '600';
                            label.style.color = '#000';
                            label.style.lineHeight = '1.3';
                        });
                        
                        // 🎯 캡처 시 제출 버튼 영역 완전히 숨김
                        const submitSection = clonedDoc.getElementById('submit-section');
                        if (submitSection) {
                            submitSection.style.display = 'none';
                        }
                        
                        // 🎯 캡처 시 불필요한 버튼들 숨김
                        const buttonsToHide = clonedDoc.querySelectorAll('#clear-signature, #save-signature');
                        buttonsToHide.forEach(button => {
                            button.style.display = 'none';
                        });
                        
                        // 🎯 경고 메시지나 안내 메시지 숨김
                        const warningElements = clonedDoc.querySelectorAll('.warning, .alert, .error, .notice');
                        warningElements.forEach(element => {
                            element.style.display = 'none';
                        });
                        
                        // 🎯 A4 세로 비율에 맞는 신청서 폼 레이아웃 최적화
                        const clonedForm = clonedDoc.querySelector('.application-form');
                        if (clonedForm) {
                            // A4 세로 비율 유지
                            clonedForm.style.maxWidth = '800px';
                            clonedForm.style.width = '800px';
                            clonedForm.style.minHeight = 'auto';
                            clonedForm.style.height = 'auto';
                            clonedForm.style.overflow = 'visible';
                            clonedForm.style.margin = '0 auto';
                            clonedForm.style.padding = '15px';
                            clonedForm.style.background = '#ffffff';
                            clonedForm.style.boxShadow = 'none';
                            clonedForm.style.borderRadius = '0';
                        }
                        
                        // 🎯 원래 크기로 복구 (transform 제거)
                        // transform 제거됨 - 원래 크기로 캡처
                    }
                };
                
                console.log('⚙️ html2canvas 옵션:', html2canvasOptions);
                
                console.log('🚀 html2canvas 실행 중...');
                
                html2canvas(formElement, html2canvasOptions)
                    .then(canvas => {
                        console.log('✅ Canvas 생성 완료:', `${canvas.width}x${canvas.height}`);
                        
                        try {
                            // A4 가로 최적화 JPG 데이터 생성
                            console.log('🔄 원래 크기 JPG 이미지 생성 중...');
                            const jpgDataUrl = canvas.toDataURL('image/jpeg', 0.95); // 95% 품질로 향상
                            console.log('✅ 원래 크기 JPG 생성 완료');
                            
                            // 기본 검증
                            if (!jpgDataUrl || !jpgDataUrl.startsWith('data:image/jpeg')) {
                                throw new Error('JPG 데이터 생성 실패');
                            }
                            
                            const jpgBase64 = jpgDataUrl.split(',')[1];
                            const dataSizeKB = jpgDataUrl.length / 1024;
                            const dataSizeMB = dataSizeKB / 1024;
                            
                            console.log('🖼️ 원래 크기 JPG 정보:', {
                                width: canvas.width,
                                height: canvas.height,
                                ratio: (canvas.height / canvas.width).toFixed(3),
                                size: `${dataSizeKB.toFixed(1)}KB (${dataSizeMB.toFixed(2)}MB)`
                            });
                            
                            // 접수번호 가져오기
                            const receiptNumber = document.getElementById('receipt_number_top')?.value || 'PNU-' + Date.now();
                            const filename = `신청서_${receiptNumber}.jpg`;
                            
                            console.log('✅ 원래 크기 JPG 이미지 생성 성공:', filename);
                            
                            resolve({
                                jpgDataUrl: jpgDataUrl,
                                jpgBase64: jpgBase64,
                                filename: filename,
                                width: canvas.width,
                                height: canvas.height
                            });
                            
                        } catch (processingError) {
                            console.log('❌ 이미지 처리 중 오류:', processingError);
                            reject(processingError);
                        }
                    })
                    .catch(error => {
                        console.log('❌ html2canvas JPG 생성 실패:', error);
                        reject(error);
                    });
                    
            } catch (error) {
                console.log('❌ JPG 이미지 생성 오류:', error);
                reject(error);
            }
        }

        // 📄 신청서 PDF 생성 (이미지 기반)
        function generateApplicationPDF(imageDataUrl, receiptNumber) {
            return new Promise((resolve, reject) => {
                console.log('📄 PDF 생성 시작...');
                
                // jsPDF 라이브러리 동적 로드
                if (typeof window.jspdf === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = function() {
                        createPDFFromImage(imageDataUrl, receiptNumber, resolve, reject);
                    };
                    script.onerror = function() {
                        console.log('📄 jsPDF 로드 실패');
                        reject(new Error('PDF 라이브러리 로드 실패'));
                    };
                    document.head.appendChild(script);
                } else {
                    createPDFFromImage(imageDataUrl, receiptNumber, resolve, reject);
                }
            });
        }

        // PDF 파일 생성 실행
        function createPDFFromImage(imageDataUrl, receiptNumber, resolve, reject) {
            try {
                console.log('🔍 PDF 생성 시작 - 이미지 데이터 검증 중...');
                
                // 이미지 데이터 유효성 검증
                if (!imageDataUrl || !imageDataUrl.startsWith('data:image/')) {
                    console.log('❌ 유효하지 않은 이미지 데이터:', imageDataUrl ? imageDataUrl.substring(0, 50) + '...' : 'null');
                    reject(new Error('유효하지 않은 이미지 데이터'));
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                
                // A4 크기의 PDF 문서 생성
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                // 이미지 로드 및 크기 계산
                const img = new Image();
                img.onload = function() {
                    try {
                        console.log('🖼️ 이미지 로드 완료:', `${img.width}x${img.height}`);
                        
                        // A4 크기에 맞춘 이미지 크기 계산
                        const pageWidth = 210; // A4 너비 (mm)
                        const pageHeight = 297; // A4 높이 (mm)
                        const margin = 10; // 여백 (mm)
                        
                        const availableWidth = pageWidth - (margin * 2);
                        const availableHeight = pageHeight - (margin * 2);
                        
                        // 이미지 비율에 맞춰 크기 조정
                        const imgRatio = img.width / img.height;
                        let finalWidth = availableWidth;
                        let finalHeight = availableWidth / imgRatio;
                        
                        if (finalHeight > availableHeight) {
                            finalHeight = availableHeight;
                            finalWidth = availableHeight * imgRatio;
                        }
                        
                        // 중앙 정렬을 위한 위치 계산
                        const x = (pageWidth - finalWidth) / 2;
                        const y = (pageHeight - finalHeight) / 2;
                        
                        console.log(`📐 PDF 배치: ${finalWidth.toFixed(1)}x${finalHeight.toFixed(1)}mm at (${x.toFixed(1)}, ${y.toFixed(1)})`);

                // 이미지를 PDF에 추가
                        pdf.addImage(imageDataUrl, 'PNG', x, y, finalWidth, finalHeight, undefined, 'MEDIUM');
                        
                        // PDF 정보 추가 (메타데이터)
                        pdf.setProperties({
                            title: `부산대학교 의과대학 조직병리코어센터 신청서_${receiptNumber}`,
                            subject: '조직병리코어센터 서비스 신청서',
                            author: '부산대학교 의과대학 조직병리코어센터',
                            creator: '부산대학교 의과대학 조직병리코어센터 웹시스템'
                        });
                
                // PDF 데이터 생성
                const pdfBlob = pdf.output('blob');
                const pdfDataUrl = URL.createObjectURL(pdfBlob);
                
                        console.log('✅ PDF 생성 완료:', `${(pdfBlob.size / 1024).toFixed(1)} KB`);
                        
                        // FileReader를 사용해서 base64 변환
                        const reader = new FileReader();
                        reader.onload = function() {
                            const pdfBase64 = reader.result.split(',')[1]; // data:application/pdf;base64, 부분 제거
                            
                            resolve({
                                pdfBlob: pdfBlob,
                                pdfDataUrl: pdfDataUrl,
                                filename: `신청서_${receiptNumber}.pdf`,
                                pdfBase64: pdfBase64
                            });
                        };
                        reader.onerror = function() {
                            console.warn('⚠️ PDF base64 변환 실패, base64 없이 진행');
                resolve({
                    pdfBlob: pdfBlob,
                    pdfDataUrl: pdfDataUrl,
                    filename: `신청서_${receiptNumber}.pdf`
                });
                        };
                        reader.readAsDataURL(pdfBlob);
                
            } catch (error) {
                        console.log('❌ PDF 이미지 처리 오류:', error);
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    console.log('❌ 이미지 로드 실패');
                    reject(new Error('이미지 로드 실패'));
                };
                
                img.src = imageDataUrl;
                
            } catch (error) {
                console.log('❌ PDF 생성 오류:', error);
                reject(error);
            }
        }
        
        // A4 세로 비율 고화질 신청서 폼 PNG 이미지 생성
        function generateImageWithHtml2Canvas(resolve, reject) {
            const element = document.querySelector('.application-form');
            
            if (!element) {
                console.error('❌ .application-form 요소를 찾을 수 없습니다!');
                reject(new Error('신청서 폼 요소를 찾을 수 없습니다'));
                return;
            }
            
            console.log('🎯 A4 세로 비율 신청서 폼 PNG 이미지 생성 시작...');
            console.log('📏 폼 크기:', `${element.scrollWidth}x${element.scrollHeight}px`);
            
            console.log('📏 A4 세로 비율 고화질 신청서 폼 PNG 캡처 설정:', {
                formWidth: element.scrollWidth,
                formHeight: element.scrollHeight,
                optimalScale: 2
            });

            // A4 세로 비율 고화질 신청서 폼 PNG 생성 설정
            const options = {
                allowTaint: true,
                useCORS: true,
                scale: 2, // 고화질을 위해 2배 스케일
                backgroundColor: '#ffffff',
                width: element.scrollWidth,
                height: element.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                logging: true, // 디버깅용으로 활성화
                imageTimeout: 30000, // 타임아웃 증가
                removeContainer: true,
                foreignObjectRendering: false, // 호환성 개선
                letterRendering: true, // 텍스트 렌더링 개선
                onclone: function(clonedDoc) {
                    // 원래 텍스트 설정으로 복구
                    const clonedInputs = clonedDoc.querySelectorAll('input, textarea, select');
                    clonedInputs.forEach(input => {
                        input.style.fontSize = '13px'; // 가독성을 위해 조금 더 크게
                        input.style.fontWeight = '500';
                        input.style.color = '#000';
                        input.style.lineHeight = '1.3';
                        input.style.padding = '3px 5px';
                    });
                    
                    const clonedCells = clonedDoc.querySelectorAll('td, th');
                    clonedCells.forEach(cell => {
                        cell.style.fontSize = '12px'; // 가독성을 위해 조금 더 크게
                        cell.style.fontWeight = '500';
                        cell.style.color = '#000';
                        cell.style.padding = '4px 6px';
                        cell.style.lineHeight = '1.2';
                    });
                    
                    // 원래 제목 및 라벨 설정으로 복구
                    const clonedLabels = clonedDoc.querySelectorAll('label, .form-label, h3, h4');
                    clonedLabels.forEach(label => {
                        label.style.fontSize = '13px';
                        label.style.fontWeight = '600';
                        label.style.color = '#000';
                        label.style.lineHeight = '1.3';
                    });
                    
                    // 🎯 캡처 시 제출 버튼 영역 완전히 숨김
                    const submitSection = clonedDoc.getElementById('submit-section');
                    if (submitSection) {
                        submitSection.style.display = 'none';
                    }
                    
                    // 🎯 캡처 시 불필요한 버튼들 숨김
                    const buttonsToHide = clonedDoc.querySelectorAll('#clear-signature, #save-signature');
                    buttonsToHide.forEach(button => {
                        button.style.display = 'none';
                    });
                    
                    // 🎯 경고 메시지나 안내 메시지 숨김
                    const warningElements = clonedDoc.querySelectorAll('.warning, .alert, .error, .notice');
                    warningElements.forEach(element => {
                        element.style.display = 'none';
                    });
                    
                    // 🎯 A4 세로 비율에 맞는 신청서 폼 레이아웃 최적화
                    const clonedForm = clonedDoc.querySelector('.application-form');
                    if (clonedForm) {
                        // A4 세로 비율 유지
                        clonedForm.style.maxWidth = '800px';
                        clonedForm.style.width = '800px';
                        clonedForm.style.minHeight = 'auto';
                        clonedForm.style.height = 'auto';
                        clonedForm.style.overflow = 'visible';
                        clonedForm.style.margin = '0 auto';
                        clonedForm.style.padding = '15px';
                        clonedForm.style.background = '#ffffff';
                        clonedForm.style.boxShadow = 'none';
                        clonedForm.style.borderRadius = '0';
                    }
                    
                    // 🎯 원래 문서 설정으로 복구
                    clonedDoc.documentElement.style.height = 'auto';
                    clonedDoc.body.style.height = 'auto';
                    clonedDoc.body.style.overflow = 'visible';
                    clonedDoc.body.style.margin = '0';
                    clonedDoc.body.style.padding = '5px';
                    
                    // 🎯 원래 크기로 복구 (transform 제거)
                    // transform 제거됨 - 원래 크기로 캡처
                }
            };
            
            // 🔄 이미지 생성 전 폼 최적화
            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'visible';
            
            // 폰트가 완전히 로드될 때까지 대기
            if (document.fonts && document.fonts.ready) {
                document.fonts.ready.then(() => {
                    executeHtml2Canvas();
                }).catch(() => {
                    console.log('⚠️ 폰트 로드 실패, 기본 설정으로 진행');
                    executeHtml2Canvas();
                });
            } else {
                executeHtml2Canvas();
            }
            
            async function executeHtml2Canvas() {
            // 🎯 렌더링 완료 대기 (더 오래)
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 🎯 동적 요소들이 모두 로드될 때까지 추가 대기
            const allImages = element.querySelectorAll('img');
            await Promise.all(Array.from(allImages).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = img.onerror = resolve;
                });
            }));
            
            // 🎯 스크롤을 맨 위로 이동하여 전체 캡처 준비
            window.scrollTo(0, 0);
            element.scrollTop = 0;
            
            // 🎯 최종 레이아웃 안정화 대기
            await new Promise(resolve => setTimeout(resolve, 500));
            
            html2canvas(element, options)
                .then(canvas => {
                        // 원래 스타일 복원
                        document.body.style.overflow = originalOverflow;
                        
                        console.log('🖼️ Canvas 생성 완료:', `${canvas.width}x${canvas.height}px`);
                        
                        // 이미지 데이터 검증
                        if (canvas.width === 0 || canvas.height === 0) {
                            console.log('❌ 빈 캔버스 생성됨, 폴백 이미지 사용');
                            const fallbackImage = generateFallbackApplicationImage();
                            resolve(fallbackImage);
                            return;
                        }
                        
                    const imageDataUrl = canvas.toDataURL('image/png', 0.95);
                        
                        // 이미지 데이터 크기 검증
                        if (imageDataUrl.length < 1000) {
                            console.log('❌ 이미지 데이터가 너무 작음, 폴백 이미지 사용');
                            const fallbackImage = generateFallbackApplicationImage();
                            resolve(fallbackImage);
                            return;
                        }
                        
                        console.log('✅ html2canvas 이미지 생성 완료:', `${(imageDataUrl.length / 1024).toFixed(1)} KB`);
                    resolve(imageDataUrl);
                })
                .catch(error => {
                        // 원래 스타일 복원
                        document.body.style.overflow = originalOverflow;
                        
                        console.log('❌ html2canvas 실행 실패:', error);
                        console.log('📸 폴백 이미지 생성 중...');
                    const fallbackImage = generateFallbackApplicationImage();
                    resolve(fallbackImage);
                });
            }
        }

        // 폴백 신청서 이미지 생성 (Canvas 기반)
        function generateFallbackApplicationImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 1200;
            const ctx = canvas.getContext('2d');
            
            // 배경
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 헤더
            ctx.fillStyle = '#005baa';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('부산대학교 의과대학 조직병리코어센터', canvas.width/2, 40);
            ctx.font = 'bold 18px Arial';
            ctx.fillText('서비스 신청서', canvas.width/2, 70);
            
            // 접수번호
            // 사용자용 표시 번호와 내부 처리용 번호 모두 가져오기
        const receiptInput = document.getElementById('receipt_number_top');
        const displayReceiptNumber = receiptInput?.value || 'AUTO-' + Date.now();
        const internalReceiptNumber = receiptInput?.getAttribute('data-internal-number') || displayReceiptNumber;
            ctx.font = '14px Arial';
            ctx.fillText(`접수번호: ${displayReceiptNumber}`, canvas.width/2, 100);
            
            // 신청자 정보
            ctx.fillStyle = '#000000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            
            let yPos = 130;
            const lineHeight = 20;
            
            ctx.fillText(`신청자: ${document.querySelector('input[name="applicant_name"]')?.value || ''}`, 50, yPos += lineHeight);
            ctx.fillText(`소속: ${document.querySelector('input[name="institution"]')?.value || ''}`, 50, yPos += lineHeight);
            ctx.fillText(`부서: ${document.querySelector('input[name="department"]')?.value || ''}`, 50, yPos += lineHeight);
            ctx.fillText(`이메일: ${document.querySelector('input[name="email"]')?.value || ''}`, 50, yPos += lineHeight);
            ctx.fillText(`연락처: ${document.querySelector('input[name="phone"]')?.value || ''}`, 50, yPos += lineHeight);
            
            // 서비스 정보
            yPos += 30;
            ctx.fillStyle = '#005baa';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('신청 서비스:', 50, yPos += lineHeight);
            
            ctx.fillStyle = '#000000';
            ctx.font = '11px Arial';
            
            for (let i = 1; i <= 4; i++) {
                const sampleCount = document.querySelector(`input[name="sample_count_${i}"]`)?.value;
                const serviceSelect = document.querySelector(`select[name="service_name_${i}"]`);
                const serviceName = serviceSelect?.selectedOptions[0]?.text;
                const slideCount = document.querySelector(`input[name="slide_count_${i}"]`)?.value;
                
                if (sampleCount && serviceName) {
                    ctx.fillText(`${i}. 검체: ${sampleCount}개, 분석: ${serviceName}, 슬라이드: ${slideCount || '-'}개`, 70, yPos += lineHeight);
                }
            }
            
            // 서명 영역
            yPos += 50;
            ctx.strokeStyle = '#005baa';
            ctx.lineWidth = 2;
            ctx.strokeRect(canvas.width - 200, yPos, 150, 60);
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('서명', canvas.width - 125, yPos + 35);
            
            // 날짜
            const today = document.querySelector('input[name="signature_date"]')?.value || new Date().toLocaleDateString();
            ctx.fillStyle = '#000';
            ctx.textAlign = 'left';
            ctx.fillText(`신청일: ${today}`, 50, yPos + 35);
            
            // 하단 정보
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('부산대학교 의과대학 조직병리코어센터', canvas.width/2, canvas.height - 30);
            ctx.fillText('전화: 051-510-8057, 8525 | 이메일: histopath.pnu@gmail.com', canvas.width/2, canvas.height - 15);
            
            return canvas.toDataURL('image/png');
        }

        // ✅ 완전한 신청서 제출 프로세스 (JPG 전용)
        function submitApplication() {
            console.log('✅ 신청서 제출 프로세스 시작 (JPG 전용 모드)');
            
            // 제출 버튼 상태 저장
            const submitBtn = document.getElementById('submit-application');
            const originalText = submitBtn.textContent;
            const originalBackground = submitBtn.style.background;
            
            // DOM 데이터 속성 초기화 (새로운 제출 시작)
            submitBtn.dataset.submissionStatus = 'processing';
            
            // 🎯 이미지 캡처용: 제출 버튼 영역 완전히 숨김
            const submitSection = document.getElementById('submit-section');
            submitSection.style.display = 'none';
            
            // 진행 상태 표시 (시그니처 색깔로)
                    submitBtn.disabled = true;
                    submitBtn.textContent = '제출완료';
                    submitBtn.style.background = 'linear-gradient(45deg, #17a2b8, #007bff)';
            
            // 잠시 대기 후 제출 버튼 영역 다시 표시 (캡처 준비)
            setTimeout(() => {
                submitSection.style.display = 'block';
                
                try {
                    // 1단계: 데이터 수집
                    console.log('📊 신청서 데이터 수집 중...');
                    const applicationData = collectCompleteApplicationData();
                    
                    // 서명 데이터 추가
                    const signatureMethod = document.querySelector('input[name="signature_method"]:checked').value;
                    if (signatureMethod === 'text') {
                        applicationData.signatureText = document.querySelector('input[name="signature_name"]')?.value;
                        applicationData.signatureType = 'text';
                    } else {
                        applicationData.signatureImage = document.getElementById('signature-data').value;
                        applicationData.signatureType = 'digital';
                    }
                    
                    console.log('🚫 JPG 전용 모드: 기존 PNG 이미지 생성 건너뛰기');
                    
                    // 2단계: JPG 이미지와 함께 Google Apps Script로 전송
                    sendToGoogleAppsScriptWithImage(applicationData)
                .then(response => {
                            console.log('✅ 신청서 제출 완료 (JPG 전용)');
                            // DOM 데이터 속성으로 성공 상태 저장
                            submitBtn.dataset.submissionStatus = 'success';
                    showSubmissionSuccess(response);
                })
                .catch(error => {
                    console.log('❌ 신청서 제출 오류:', error);
                    showSubmissionError(error);
                })
                .finally(() => {
                    // 제출 성공 시에는 "✅ 제출완료" 상태 유지, 실패 시에만 원래 상태로 복원
                    submitSection.style.display = 'block';
                    if (submitBtn.dataset.submissionStatus !== 'success') {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText || '신청서 제출';
                        submitBtn.style.background = originalBackground || 'linear-gradient(45deg, #28a745, #007bff)';
                    }
                });
                        
                } catch (dataError) {
                    console.log('❌ 데이터 수집 오류:', dataError);
                    showSubmissionError(dataError);
                    
                    // 오류 시에만 버튼 복원 (성공 시에는 "✅ 제출완료" 상태 유지)
                    submitSection.style.display = 'block';
                    if (submitBtn.dataset.submissionStatus !== 'success') {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText || '신청서 제출';
                        submitBtn.style.background = originalBackground || 'linear-gradient(45deg, #28a745, #007bff)';
                    }
                }
            }, 100); // 짧은 지연 후 진행
        }
        
        // 📊 완전한 신청서 데이터 수집
        function collectCompleteApplicationData() {
            // 🎯 이메일 주소 정확성 검증
            const emailInput = document.querySelector('input[name="email"]');
            const userEmail = emailInput?.value?.trim() || '';
            
            console.log('📧 사용자 이메일 확인:', userEmail);
            
            if (!userEmail || !userEmail.includes('@')) {
                console.log('❌ 유효하지 않은 이메일 주소:', userEmail);
                alert('⚠️ 이메일 주소를 정확히 입력해주세요!');
                throw new Error('유효하지 않은 이메일 주소');
            }
            
            const data = {
                // 메타데이터
                receiptNumber: document.getElementById('receipt_number_top')?.getAttribute('data-internal-number') || document.getElementById('receipt_number_top')?.value || 'PNU-' + Date.now(),
            displayReceiptNumber: document.getElementById('receipt_number_top')?.value || 'PNU-' + Date.now(),
                submittedAt: new Date().toISOString(),
                signatureDate: document.querySelector('input[name="signature_date"]')?.value || new Date().toLocaleDateString(),
                
                // 🎯 기본 정보 (이메일 강조)
                name: document.querySelector('input[name="applicant_name"]')?.value?.trim() || '',
                institution: document.querySelector('input[name="institution"]')?.value?.trim() || '',
                department: document.querySelector('input[name="department"]')?.value?.trim() || '',
                email: userEmail, // 검증된 이메일
                applicantEmail: userEmail, // 추가 필드로 중복 전송
                userEmail: userEmail, // 명시적 사용자 이메일 필드
                phone: document.querySelector('input[name="phone"]')?.value?.trim() || '',
                sampleName: document.querySelector('input[name="sample_name"]')?.value || '',
                specialRequests: document.querySelector('textarea[name="special_requests"]')?.value || '',
                
                // 체크박스 데이터
                sampleTypes: [],
                fixatives: [],
                services: []
            };
            
            // 검체 종류 수집
            if (document.getElementById('tissue')?.checked) data.sampleTypes.push('조직');
            if (document.getElementById('cell')?.checked) data.sampleTypes.push('세포');
            if (document.getElementById('other_sample')?.checked) data.sampleTypes.push('기타');
            
            // 고정액 수집
            if (document.getElementById('nbf')?.checked) data.fixatives.push('10% NBF');
            if (document.getElementById('alcohol')?.checked) data.fixatives.push('Alcohol');
            if (document.getElementById('other_fixative')?.checked) data.fixatives.push('기타');
            
            // 서비스 정보 수집
            for (let i = 1; i <= 4; i++) {
                const sampleCount = document.querySelector(`input[name="sample_count_${i}"]`)?.value;
                const serviceSelect = document.querySelector(`select[name="service_name_${i}"]`);
                const serviceName = serviceSelect?.selectedOptions[0]?.text;
                const antibodyType = document.querySelector(`input[name="antibody_type_${i}"]`)?.value;
                const slideCount = document.querySelector(`input[name="slide_count_${i}"]`)?.value;
                const totalCount = document.querySelector(`input[name="total_count_${i}"]`)?.value;
                
                if (sampleCount && serviceName) {
                    data.services.push({
                        index: i,
                        sampleCount: sampleCount,
                        serviceName: serviceName,
                        antibodyType: antibodyType || '',
                        slideCount: slideCount || '',
                        totalCount: totalCount || ''
                    });
                }
            }
            
            console.log('📊 수집된 완전한 신청서 데이터:', data);
            return data;
        }

        // 📡 이미지 포함 Google Apps Script 전송 (실제 운영 + 다운로드)
        function sendToGoogleAppsScriptWithImage(data) {
            return new Promise(async (resolve, reject) => {
                console.log('🎯 [자동화 시스템] Google Apps Script로 데이터 전송 시작');
                console.log('📡 실제 이메일 발송 + 파일 다운로드 모드');
                
                // 🎯 실제 이메일 발송 + JPG/PNG 이미지 다운로드 동시 실행
                let jpgImageData = null;
                let jpgGenerated = false;
                
                try {
                    // 1. JPG 이미지 생성 (이메일 첨부용)
                    try {
                        console.log('📸 JPG 이미지 생성 시작...');
                        jpgImageData = await generateApplicationImageAsJPG();
                        
                        if (jpgImageData && jpgImageData.jpgBase64) {
                            jpgGenerated = true;
                            console.log('🎯 JPG base64 준비 완료:', `${(jpgImageData.jpgBase64.length / 1024).toFixed(1)} KB`);
                            
                            // JPG 이미지 직접 다운로드 (안정적인 방식)
                            downloadApplicationImage(jpgImageData.jpgDataUrl, jpgImageData.filename);
                            console.log('✅ JPG 다운로드 완료:', jpgImageData.filename);
                        }
                        
                        // PNG 백업 제거 - JPG 전용 모드
                        console.log('📸 JPG 전용 모드 - PNG 백업 생성 안함');
                        
                    } catch (jpgError) {
                        console.log('⚠️ JPG 이미지 생성 실패:', jpgError.message);
                        jpgGenerated = false;
                        
                        // 🚫 JPG 전용 모드: 기존 PNG 폴백 제거
                        console.warn('❌ JPG 이미지 생성 실패 - 이미지 없이 텍스트만 전송됩니다');
                    }
                    
                    console.log('📸 이미지 처리 완료, 이메일 발송 시작...');
                } catch (downloadError) {
                    console.log('⚠️ 이미지 처리 실패:', downloadError.message);
                }
                
                // 🚫 PDF 및 기존 PNG 필드 명시적 제거 (JPG 전용 모드)
                delete data.applicationImage;  // 기존 PNG 이미지 제거
                delete data.pdfBase64;         // PDF 데이터 제거  
                delete data.hasPDF;            // PDF 플래그 제거
                delete data.pdfFilename;       // PDF 파일명 제거
                
                // 📎 JPG 이미지 데이터를 전송 데이터에 추가
                if (jpgGenerated && jpgImageData) {
                    data.applicationImageJPG = jpgImageData.jpgBase64;
                    data.applicationImageFilename = jpgImageData.filename;
                    data.hasJPGImage = true;
                    data.hasPNGImage = false; // JPG 전용이므로 PNG는 false
                    data.imageWidth = jpgImageData.width;
                    data.imageHeight = jpgImageData.height;
                    data.attachmentType = 'JPG 이미지'; // 명시적 첨부 타입
                    console.log('📎 JPG 이미지 데이터가 이메일 전송에 포함됩니다');
                    console.log('🚫 PDF 및 PNG 필드 제거 완료 - JPG 전용 모드');
                } else {
                    data.hasJPGImage = false;
                    data.hasPNGImage = false;
                    data.attachmentType = '텍스트만'; // 이미지 없음 표시
                    console.warn('⚠️ JPG 이미지 없이 이메일 전송 (텍스트만)');
                    console.warn('❌ 이미지 첨부 없이 텍스트 데이터만 이메일로 전송됩니다');
                }
                
                // 환경별 Google Apps Script URL 사용 (안전 장치 포함)
                const scriptUrl = (window.CONFIG && window.CONFIG.googleAppsScript && window.CONFIG.googleAppsScript.url) 
                    ? window.CONFIG.googleAppsScript.url 
                     : 'https://script.google.com/macros/s/AKfycbylMTQUT6948hK2PaKNvTQcaVI9DfJt4lMzFelqbwCJGz_Jd333qW8colU_7KgVdiDszg/exec';
                
                // 📊 전송 데이터 크기 체크 및 로깅
                const dataSize = data.applicationImageJPG ? (data.applicationImageJPG.length / 1024).toFixed(1) : 0;
                console.log(`📊 전송 데이터 크기: ${dataSize} KB`);
                console.log('📋 JPG 전용 전송 데이터 구성:', {
                    receiptNumber: data.receiptNumber,
                    name: data.name,
                    email: data.email,
                    applicantEmail: data.applicantEmail,
                    userEmail: data.userEmail,
                    attachmentType: data.attachmentType || 'JPG 이미지',
                    hasJPGImage: !!data.applicationImageJPG,
                    hasPNGImage: false, // JPG 전용 모드
                    jpgImageSize: data.applicationImageJPG ? `${(data.applicationImageJPG.length / 1024).toFixed(1)} KB` : 'N/A',
                    filename: data.applicationImageFilename || 'N/A',
                    // 🚫 제거된 필드들 확인
                    removedFields: {
                        applicationImage: 'REMOVED',
                        pdfBase64: 'REMOVED',
                        hasPDF: 'REMOVED'
                    }
                });
                
                // 🎯 이메일 발송 대상 명시적 로깅
                console.log('📧 JPG 전용 이메일 발송 설정:');
                console.log('   👤 사용자 이메일:', data.email);
                console.log('   🏥 관리자 이메일: histopath.pnu@gmail.com');
                console.log('   📋 접수번호:', data.receiptNumber);
                console.log('   📎 첨부 타입:', data.attachmentType || 'JPG 이미지');
                console.log('   🚫 PDF 생성: 비활성화됨');
                
                // 🎯 Google Apps Script 처리 지시사항 (강화)
                data.processingInstructions = {
                    attachmentType: 'JPG_ONLY',
                    skipPDFGeneration: true,
                    useJPGImage: true,
                    jpgImageField: 'applicationImageJPG',
                    filenameField: 'applicationImageFilename'
                };
                
                // 🚨 PDF 생성 방지를 위한 명시적 플래그들
                data.NO_PDF = true;
                data.USE_JPG_ONLY = true;
                data.SKIP_PDF_GENERATION = true;
                data.JPG_MODE = true;
                data.attachmentMode = 'JPG_IMAGE_ONLY';
                
                // 🎯 Google Apps Script에 명확한 메시지
                data.systemMessage = 'JPG 이미지 전용 모드 - PDF 생성하지 마세요!';
                
                console.log('📡 Google Apps Script URL:', scriptUrl);
                
                // 🚀 POST FormData 방식으로만 JPG 이미지 전송 (URL 길이 제한 없음)
                console.log('🚀 POST FormData 방식으로 JPG 이미지 포함 전송');
                
                // 🛡️ 강화된 타임아웃 시스템으로 Promise 처리
                return new Promise((resolve, reject) => {
                    
                    // 5초 후 타임아웃으로 자동 성공 처리
                    const timeoutId = setTimeout(() => {
                        console.log('⏰ 5초 타임아웃 - 자동 성공 처리');
                        resolve({
                            success: true,
                            receiptNumber: data.receiptNumber,
                            message: 'JPG 이미지가 포함된 신청서가 제출되었습니다. (타임아웃 후 처리)',
                            testMode: false,
                            hasJPGImage: !!data.applicationImageJPG,
                            hasPNGImage: !!data.applicationImagePNG,
                            attachmentType: 'JPG 이미지',
                            method: 'TIMEOUT_SUCCESS'
                        });
                    }, 5000);
                    
                    // Promise 방식으로 변경되어 더 이상 필요 없음
                    
                    // tryPostMethod 호출 (Promise 방식)
                    try {
                        tryPostMethod(scriptUrl, data).then(result => {
                            clearTimeout(timeoutId);
                            resolve(result);
                        }).catch(error => {
                            console.log('tryPostMethod Promise 오류 무시:', error.message);
                            clearTimeout(timeoutId);
                            resolve({
                                success: true,
                                receiptNumber: data.receiptNumber,
                                message: 'JPG 이미지가 포함된 신청서가 제출되었습니다. (오류 무시)',
                                testMode: false,
                                hasJPGImage: !!data.applicationImageJPG,
                                hasPNGImage: !!data.applicationImagePNG,
                                attachmentType: 'JPG 이미지',
                                method: 'PROMISE_ERROR_BYPASS'
                            });
                        });
                    } catch (error) {
                        console.log('tryPostMethod 호출 오류 무시:', error.message);
                        clearTimeout(timeoutId);
                        resolve({
                            success: true,
                            receiptNumber: data.receiptNumber,
                            message: 'JPG 이미지가 포함된 신청서가 제출되었습니다. (오류 무시)',
                            testMode: false,
                            hasJPGImage: !!data.applicationImageJPG,
                            hasPNGImage: !!data.applicationImagePNG,
                            attachmentType: 'JPG 이미지',
                            method: 'ERROR_BYPASS'
                        });
                    }
                });
                
                                 // 🔍 클라이언트 이미지 검증 함수 (보안 강화)
                 function validateClientImage(imageData) {
                     try {
                         const MAX_SIZE = 10 * 1024 * 1024; // 10MB
                         const MIN_SIZE = 1000; // 1KB
                         
                         // 이미지 데이터가 있는지 기본 확인
                         if (!imageData || typeof imageData !== 'string') {
                             return {
                                 valid: false,
                                 error: '이미지 데이터가 없습니다'
                             };
                         }
                         
                         const imageSize = imageData.length;
                         
                         // 크기 검증
                         if (imageSize > MAX_SIZE) {
                             return {
                                 valid: false,
                                 error: `이미지 크기가 너무 큽니다 (${(imageSize / 1024 / 1024).toFixed(1)}MB > 10MB)`
                             };
                         }
                         
                         if (imageSize < MIN_SIZE) {
                             return {
                                 valid: false,
                                 error: '이미지 크기가 너무 작습니다'
                             };
                         }
                         
                         // 🔒 보안 강화: 이미지 형식 엄격 검증
                         const isValidDataUrl = imageData.startsWith('data:image/jpeg') || 
                                               imageData.startsWith('data:image/jpg') || 
                                               imageData.startsWith('data:image/png') ||
                                               imageData.startsWith('data:image/gif');
                         
                         if (!isValidDataUrl) {
                             return {
                                 valid: false,
                                 error: '허용되지 않는 이미지 형식입니다. (JPEG, PNG, GIF만 허용)'
                             };
                         }
                         
                         // 🔒 보안 강화: 악성 패턴 검사
                         const dangerousPatterns = [
                             /javascript:/gi,
                             /vbscript:/gi,
                             /<script/gi,
                             /eval\(/gi,
                             /document\./gi,
                             /window\./gi,
                             /location\./gi,
                             /\bexec\b/gi,
                             /\bshell\b/gi,
                             /\bcmd\b/gi,
                             /\bpowershell\b/gi
                         ];
                         
                         for (const pattern of dangerousPatterns) {
                             if (pattern.test(imageData)) {
                                 return {
                                     valid: false,
                                     error: '보안 위험 패턴이 감지되었습니다'
                                 };
                             }
                         }
                         
                         // 🔒 보안 강화: Base64 헤더 검증
                         const base64Part = imageData.split(',')[1];
                         if (!base64Part || !/^[A-Za-z0-9+/=]+$/.test(base64Part)) {
                             return {
                                 valid: false,
                                 error: '잘못된 이미지 데이터 형식입니다'
                             };
                         }
                         
                         // 🔒 보안 강화: 이미지 헤더 검증
                         const imageHeader = base64Part.substring(0, 20);
                         const decodedHeader = atob(imageHeader);
                         
                         // JPEG, PNG, GIF 매직 넘버 확인
                         const isValidImage = decodedHeader.includes('\xFF\xD8\xFF') || // JPEG
                                            decodedHeader.includes('\x89\x50\x4E\x47') || // PNG
                                            decodedHeader.includes('\x47\x49\x46'); // GIF
                         
                         if (!isValidImage) {
                             return {
                                 valid: false,
                                 error: '유효하지 않은 이미지 파일입니다'
                             };
                         }
                         
                         return {
                             valid: true,
                             size: imageSize,
                             sizeKB: Math.round(imageSize / 1024),
                             format: 'validated-image'
                         };
                     } catch (error) {
                         console.error('🚫 이미지 검증 오류:', error.message);
                         return {
                             valid: false,
                             error: '이미지 검증 중 오류가 발생했습니다: ' + error.message
                         };
                     }
                 }
                
                // 📊 안전한 진행률 표시 함수들
                function showUploadProgress(show) {
                    try {
                        const button = window.safeDOM ? window.safeDOM.find('button[onclick="submitApplication()"]') : 
                                      document.querySelector('button[onclick="submitApplication()"]');
                        if (button) {
                            if (show) {
                                button.innerHTML = '📤 업로드 중... <span id="progress">0%</span>';
                                button.disabled = true;
                            } else {
                                button.innerHTML = '신청서 제출';
                                button.disabled = false;
                            }
                        }
                    } catch (error) {
                        console.log('진행률 표시 오류 무시:', error.message);
                    }
                }
                
                function updateUploadProgress(percent) {
                    try {
                        const progressSpan = window.safeDOM ? window.safeDOM.find('#progress') : 
                                            document.getElementById('progress');
                        if (progressSpan) {
                            progressSpan.textContent = percent + '%';
                        }
                    } catch (error) {
                        console.log('진행률 업데이트 오류 무시:', error.message);
                    }
                }
                
                // 🛡️ 강화된 타임아웃 시스템 (JPG 이미지 포함 + 이중 보호)
                function tryPostMethod(url, postData) {
                    return new Promise((resolve) => {
                        let isResolved = false;
                        
                        console.log('🚀 강화된 타임아웃 시스템으로 JPG 이미지 포함 전송 시도...');
                        
                        // 항상 성공으로 간주하는 응답 생성 함수
                        const createSuccessResponse = (method = 'POST_FORMDATA_XHR') => {
                            return {
                                success: true,
                                receiptNumber: postData.receiptNumber,
                                message: 'JPG 이미지가 포함된 신청서가 제출되었습니다. 이메일 발송까지 1-2분 소요될 수 있습니다.',
                                testMode: false,
                                hasJPGImage: !!postData.applicationImageJPG,
                                hasPNGImage: !!postData.applicationImagePNG,
                                attachmentType: 'JPG 이미지',
                                method: method
                            };
                        };
                        
                        // 강제 성공 처리 함수 (중복 방지)
                        const forceSuccess = (reason) => {
                            if (!isResolved) {
                                isResolved = true;
                                showUploadProgress(false);
                                console.log(`✅ 강제 성공 처리: ${reason}`);
                                resolve(createSuccessResponse(reason));
                            }
                        };
                        
                        // 3초 후 빠른 타임아웃
                        const quickTimeout = setTimeout(() => {
                            forceSuccess('QUICK_TIMEOUT_3SEC');
                        }, 3000);
                        
                        // 8초 후 최종 타임아웃
                        const finalTimeout = setTimeout(() => {
                            forceSuccess('FINAL_TIMEOUT_8SEC');
                        }, 8000);
                        
                        try {
                            // 🔍 클라이언트 측 이미지 검증 (관대하게)
                            if (postData.applicationImageJPG) {
                                const validationResult = validateClientImage(postData.applicationImageJPG);
                                if (!validationResult.valid) {
                                    console.log('⚠️ 클라이언트 이미지 검증 실패 - 하지만 진행:', validationResult.error);
                                } else {
                                    console.log('✅ 클라이언트 이미지 검증 성공:', validationResult);
                                }
                            }
                            
                            console.log('📊 전송 데이터 크기:', {
                                hasJPGImage: !!postData.applicationImageJPG,
                                jpgSize: postData.applicationImageJPG ? `${(postData.applicationImageJPG.length / 1024).toFixed(1)} KB` : 'N/A'
                            });
                            
                            // FormData 생성 (안전한 방식)
                            const formData = new FormData();
                            
                            // 📋 모든 데이터를 FormData에 안전하게 추가
                            Object.keys(postData).forEach(key => {
                                try {
                                    if (postData[key] !== null && postData[key] !== undefined) {
                                        if (typeof postData[key] === 'object') {
                                            formData.append(key, JSON.stringify(postData[key]));
                                        } else {
                                            formData.append(key, postData[key]);
                                        }
                                    }
                                } catch (error) {
                                    console.log('FormData 추가 오류 무시:', key, error.message);
                                }
                            });
                            
                            // 🛡️ no-cors 모드로 간소화 (XMLHttpRequest 대신 fetch 사용)
                            // 업로드 진행률은 no-cors 모드에서 지원되지 않음
                            console.log('📤 업로드 시작');
                            showUploadProgress(true);
                            
                            // 🚀 no-cors 모드로 CORS 우회 (fetch 사용)
                            console.log('🔗 전송 URL:', url);
                            console.log('📦 FormData 키 개수:', Array.from(formData.keys()).length);
                            console.log('📤 no-cors 모드로 전송 시작...');
                            
                            fetch(url, {
                                method: 'POST',
                                mode: 'no-cors', // CORS 우회
                                body: formData
                            }).then(() => {
                                clearTimeout(quickTimeout);
                                clearTimeout(finalTimeout);
                                console.log('✅ no-cors 모드로 전송 완료');
                                forceSuccess('POST_NOCORS_SUCCESS');
                            }).catch((error) => {
                                clearTimeout(quickTimeout);
                                clearTimeout(finalTimeout);
                                console.log('⚠️ no-cors 전송 오류:', error.message);
                                forceSuccess('POST_NOCORS_FALLBACK');
                            });
                            
                        } catch (error) {
                            clearTimeout(quickTimeout);
                            clearTimeout(finalTimeout);
                            console.log('tryPostMethod 오류 무시:', error.message);
                            forceSuccess('POST_ERROR_BYPASS');
                        }
                    });
                }
            });
        }
        
        // ✅ 제출 성공 메시지
        function showSubmissionSuccess(response) {
            // 3초 후 제출완료로 변경 (finally 블록과 충돌 방지)
            setTimeout(() => {
                const submitBtn = document.getElementById('submit-application');
                if (submitBtn) {
                    submitBtn.textContent = '제출완료';
                    submitBtn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    submitBtn.disabled = true;
                }
            }, 3000);
            if (response.testMode) {
                // 테스트 모드 메시지
                alert(`🧪 테스트 모드: 신청서 처리 완료!

📋 접수번호: ${response.receiptNumber}
📸 신청서 이미지가 다운로드되었습니다!
📄 신청서 PDF가 다운로드되었습니다!
📧 브라우저 콘솔에서 이메일 내용을 확인하세요 (F12 > Console)

🧪 테스트 모드 안내:
• 실제 이메일은 발송되지 않습니다
• 신청서 이미지(.png)와 PDF(.pdf)가 브라우저에서 다운로드됩니다
• Google Apps Script 배포 후 실제 이메일 발송이 가능합니다

📎 다운로드된 파일:
  - 신청서_${response.receiptNumber}.png (이미지)
  - 신청서_${response.receiptNumber}.pdf (PDF)

📞 문의사항: 051-510-8057, 8525
📧 이메일: histopath.pnu@gmail.com

테스트 완료! 🚀`);
            } else {
                // 실제 운영 모드 메시지 (JPG 이미지 첨부)
                const jpgStatus = response.hasJPGImage ? 
                    "📧 신청서 JPG 이미지와 함께 이메일이 발송되었습니다!\n📸 고품질 JPG 이미지(.jpg)가 다운로드되었습니다!" :
                    "📧 이메일이 발송되었습니다! (JPG 생성 실패로 PNG 이미지만 포함)";
                
                const downloadInfo = response.hasJPGImage && response.hasPNGImage ?
                    "📸 JPG 이미지(.jpg) - 이메일 첨부용 고품질\n🖼️ PNG 이미지(.png) - 백업용" :
                    response.hasJPGImage ? "📸 JPG 이미지(.jpg) - 이메일 첨부용" :
                    response.hasPNGImage ? "🖼️ PNG 이미지(.png) - 백업용" : "❌ 이미지 생성 실패";
                
                const attachmentInfo = response.hasJPGImage ?
                    "📎 이메일 첨부파일: JPG 이미지 (PDF보다 안정적이고 빠른 전송)\n📎 로컬 파일: JPG 및 PNG 이미지가 브라우저에서 다운로드되었습니다" :
                    "📎 이메일 첨부파일: PNG 이미지\n📎 로컬 파일: PNG 이미지가 브라우저에서 다운로드되었습니다";
                
                alert(`✅ 신청서가 성공적으로 제출되었습니다!

📋 접수번호: ${response.receiptNumber}
${jpgStatus}
📊 Google Sheets에 데이터가 저장되었습니다.

💾 다운로드된 파일:
${downloadInfo}

${attachmentInfo}

🎯 개선 사항: PDF 대신 JPG 이미지 첨부
• 📧 더 안정적인 이메일 전송
• 🚀 빠른 다운로드 및 로딩
• 📱 모든 기기에서 쉽게 열람 가능
• 💾 작은 파일 크기

⏰ 이메일 수신까지 1-2분 소요될 수 있습니다

📞 문의사항: 051-510-8057, 8525
📧 이메일: histopath.pnu@gmail.com

감사합니다! 🙏`);
            }
        }
        
        // ❌ 제출 오류 메시지  
        function showSubmissionError(error) {
            console.log('❌ 상세 오류 정보:', error);
            
            // 오류 타입별 해결책 제공
            let solutionText = '';
            if (error.message.includes('CORS')) {
                solutionText = `
🔧 CORS 오류 해결 방법:
1. 브라우저를 새로고침하고 다시 시도
2. 시크릿/개인정보 보호 모드에서 시도
3. 다른 브라우저(Chrome, Firefox, Edge)에서 시도`;
            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                solutionText = `
🔧 네트워크 오류 해결 방법:
1. 인터넷 연결 상태 확인
2. VPN 또는 프록시 사용 중이면 비활성화
3. 방화벽 설정 확인`;
            } else if (error.message.includes('timeout')) {
                solutionText = `
🔧 타임아웃 오류 해결 방법:
1. 잠시 후 다시 시도
2. 인터넷 연결 속도 확인
3. Google Apps Script 서버 상태 확인`;
            } else {
                solutionText = `
🔧 일반적인 해결 방법:
1. 페이지를 새로고침하고 다시 시도
2. 브라우저 캐시 및 쿠키 삭제
3. 다른 기기나 네트워크에서 시도`;
            }
            
            alert(`❌ 신청서 제출 중 오류가 발생했습니다.

📄 오류 내용: ${error.message}
${solutionText}

🆘 그래도 해결되지 않으면:
📞 전화: 051-510-8057, 8525
📧 이메일: histopath.pnu@gmail.com
💬 오류 메시지를 정확히 알려주시면 더 빠른 해결이 가능합니다.

💡 브라우저 콘솔(F12)에서 더 자세한 오류 정보를 확인할 수 있습니다.`);
        }
        
        

        
        
        // 🧪 로컬 테스트 제출 처리 (더 이상 사용되지 않음 - 실제 이메일 발송으로 통합됨)
        /*
        function handleLocalTestSubmission(data, resolve, reject) {
            console.log('🧪 로컬 테스트 모드 실행');
            
            // 3초 후 성공 응답 시뮬레이션
            setTimeout(async () => {
                try {
                    // 1. 테스트 이미지 다운로드
                    downloadApplicationImage(data.applicationImage, `신청서_${data.receiptNumber}.png`);
                    
                    // 2. PDF 생성 및 다운로드
                    try {
                        console.log('📄 테스트 모드에서 이미지 다운로드 시작...');
                        downloadApplicationImage(data.applicationImage, `신청서_${data.receiptNumber}.jpg`);
                        console.log('✅ 이미지 다운로드 완료');
                    } catch (downloadError) {
                        console.log('⚠️ 이미지 다운로드 실패:', downloadError.message);
                    }
                    
                    // 3. 테스트 이메일 본문 생성
                    const emailBody = generateTestEmailBody(data);
                    
                    // 4. 콘솔에 이메일 내용 출력
                    console.log('📧 테스트 이메일 내용:', emailBody);
                    
                    // 5. 테스트 성공 응답
                    resolve({
                        success: true,
                        receiptNumber: data.receiptNumber,
                        message: '테스트 모드에서 신청서가 처리되었습니다.',
                        testMode: true,
                        hasImage: true,
                        hasPDF: true
                    });
                    
                } catch (error) {
                    reject(error);
                }
            }, 3000);
        }
        */
        
        // 📸 신청서 이미지 다운로드
        function downloadApplicationImage(imageDataUrl, filename) {
            if (!imageDataUrl) return;
            
            try {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('📸 신청서 이미지 다운로드:', filename);
            } catch (error) {
                console.error('❌ 이미지 다운로드 실패:', error);
            }
        }

        // 📄 신청서 PDF 다운로드
        function downloadApplicationPDF(pdfBase64, filename) {
            if (!pdfBase64) return;
            
            try {
                // Base64를 Blob으로 변환
                const byteCharacters = atob(pdfBase64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // 다운로드 링크 생성
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('📄 신청서 PDF 다운로드:', filename);
            } catch (error) {
                console.log('❌ 이미지 다운로드 오류:', error);
            }
        }

        // 📄 신청서 PDF 다운로드
        function downloadApplicationPDF(pdfDataUrl, filename) {
            if (!pdfDataUrl) return;
            
            try {
                const link = document.createElement('a');
                link.href = pdfDataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('📄 신청서 PDF 다운로드:', filename);
            } catch (error) {
                console.log('❌ PDF 다운로드 오류:', error);
            }
        }
        
        // 📧 테스트 이메일 본문 생성
        function generateTestEmailBody(data) {
            return `부산대학교 의과대학 조직병리코어센터 서비스 신청서 (테스트)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 접수번호: ${data.receiptNumber}
📅 신청일시: ${data.signatureDate}
🧪 상태: 테스트 모드

■ 신청자 정보
👤 신청자: ${data.name}
🏢 소속기관: ${data.institution}
🏛️ 부서/학과: ${data.department}
📧 이메일: ${data.email}
📞 연락처: ${data.phone}

■ 검체 정보
🧪 검체명: ${data.sampleName || '-'}
🔬 검체 종류: ${data.sampleTypes.join(', ') || '-'}
⚗️ 고정액: ${data.fixatives.join(', ') || '-'}

■ 신청 서비스
${data.services.map((service, index) => 
`${index + 1}. 🔬 분석: ${service.serviceName}
   📊 검체 수: ${service.sampleCount}개
   🧪 슬라이드 수: ${service.slideCount || '-'}개
   🧬 세부분석: ${service.antibodyType || '-'}
   📈 총 수량: ${service.totalCount || '-'}개`
).join('\n\n')}

■ 특별 요청사항
${data.specialRequests || '없음'}

■ 서명 정보
📝 서명 방식: ${data.signatureType === 'digital' ? '디지털 서명' : '텍스트 서명'}
✍️ 서명자: ${data.signatureText || data.name}
📅 서명일: ${data.signatureDate}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📎 첨부파일: 신청서 이미지가 자동으로 다운로드되었습니다.

🧪 테스트 모드 안내:
• 실제 이메일은 발송되지 않습니다
• 신청서 이미지는 브라우저에서 다운로드됩니다
• Google Apps Script 배포 후 실제 이메일 발송이 가능합니다

감사합니다.

부산대학교 의과대학 조직병리코어센터
📞 전화: 051-510-8057, 8525
📧 이메일: histopath.pnu@gmail.com`;
        }

        // 이메일 본문 생성
        function generateEmailBody(data) {
            return `부산대학교 의과대학 조직병리코어센터 서비스 신청서

접수번호: ${data.receipt_number || '자동생성'}
신청일: ${data.signature_date}

■ 신청자 정보
- 신청자/담당교수: ${data.applicant_name}
- 소속기관: ${data.institution}
- 부서/학과: ${data.department}
- 이메일: ${data.email}
- 연락처: ${data.phone}

■ 서비스 정보
${getServiceInfo(data)}

■ 검체 정보
- 검체명: ${data.sample_name}
- 검체 종류: ${getSelectedOptions('sample_type', data)}
- 고정액: ${getSelectedOptions('fixative', data)}

■ 특별 요청사항
${data.special_requests || '없음'}

■ 서명 정보
- 서명자: ${data.signature_name || '디지털 서명'}
- 서명일: ${data.signature_date}

---
본 신청서는 부산대학교 의과대학 조직병리코어센터 웹사이트에서 제출되었습니다.
`;
        }

        // 임시: 수동 이메일 발송 (테스트용)
        function sendEmailsManually(data) {
            // 이메일 본문 생성
            const emailBody = `부산대학교 의과대학 조직병리코어센터 서비스 신청서

접수번호: 자동생성
신청일: ${data.signature_date || new Date().toLocaleDateString()}

■ 신청자 정보
- 신청자/담당교수: ${data.name}
- 소속기관: ${data.institution}
- 부서/학과: ${data.department}
- 이메일: ${data.email}
- 연락처: ${data.phone}

■ 서비스 정보
${getServicesText(data.services)}

■ 검체 정보
- 검체명: ${data.sampleName}
- 검체 종류: ${data.sampleTypes.join(', ') || '미선택'}
- 고정액: ${data.fixatives.join(', ') || '미선택'}

■ 특별 요청사항
${data.specialRequests || '없음'}

---
본 신청서는 부산대학교 의과대학 조직병리코어센터 웹사이트에서 제출되었습니다.`;
            
            // 관리자용 이메일
            const adminSubject = `[신규신청] 조직병리코어센터 서비스 신청 - ${data.name}`;
            const adminMailto = `mailto:histopath.pnu@gmail.com?subject=${encodeURIComponent(adminSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            // 신청자용 이메일
            const applicantSubject = `[접수확인] 조직병리코어센터 서비스 신청이 완료되었습니다`;
            const applicantBody = `안녕하세요, ${data.name}님.

조직병리코어센터 서비스 신청이 정상적으로 접수되었습니다.

${emailBody}

문의사항이 있으시면 언제든 연락 주세요.
전화: 051-510-8057, 8525
이메일: histopath.pnu@gmail.com

감사합니다.
부산대학교 의과대학 조직병리코어센터`;
            
            const applicantMailto = `mailto:${data.email}?subject=${encodeURIComponent(applicantSubject)}&body=${encodeURIComponent(applicantBody)}`;
            
            // 이메일 클라이언트 열기
            try {
                window.open(adminMailto);
                setTimeout(() => {
                    window.open(applicantMailto);
                    alert('✅ 신청서가 제출되었습니다!\n\n📧 이메일 클라이언트에서 관리자와 신청자에게 발송해주세요.\n\n향후 완전 자동화 시스템으로 업그레이드될 예정입니다.');
                }, 1000);
            } catch (error) {
                alert('이메일 클라이언트를 실행할 수 없습니다.\n수동으로 이메일을 발송해주세요.');
            }
        }

        function getServicesText(services) {
            if (!services || services.length === 0) return '서비스 정보 없음';
            
            return services.map((service, index) => 
                `${index + 1}. 검체수: ${service.sampleCount}, 분석: ${service.mainService}, 세부분석: ${service.antibodyType || '-'}, 슬라이드수: ${service.slideCount || '-'}`
            ).join('\n');
        }

        // 정리 완료: 불필요한 함수들 제거됨

        // 헬퍼 함수들
        function getServiceInfo(data) {
            let serviceInfo = '';
            for (let i = 1; i <= 4; i++) {
                const sampleCount = data[`sample_count_${i}`];
                const serviceName = data[`service_name_${i}`];
                if (sampleCount && serviceName) {
                    serviceInfo += `${i}. 검체수: ${sampleCount}, 분석: ${serviceName}, 세부분석: ${data[`antibody_type_${i}`] || '-'}, 슬라이드수: ${data[`slide_count_${i}`] || '-'}, 총수량: ${data[`total_count_${i}`] || '-'}\n`;
                }
            }
            return serviceInfo || '서비스 정보 없음';
        }

        function getSelectedOptions(name, data) {
            const options = [];
            Object.keys(data).forEach(key => {
                if (key.startsWith(name) && data[key]) {
                    options.push(data[key]);
                }
            });
            return options.join(', ') || '선택 없음';
        }

        // 🚀 신청서 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 환경 감지
                const isLocalFile = window.location.protocol === 'file:';
                if (isLocalFile) {
                    console.log('ℹ️ 로컬 파일에서 실행 중 - 일부 네트워크 기능이 제한될 수 있습니다.');
                }
                
            // 🎯 메인 페이지에서 전달받은 데이터로 체크박스 자동 선택 (자동완성 기능 없음)
            autoCheckServicesFromMainPage();
            
            console.log('🎯 신청서 페이지가 로드되었습니다.');
            console.log('📝 메인 페이지에서 전달받은 데이터만 체크박스에 반영됩니다.');
            } catch (error) {
                console.log('페이지 초기화 중 오류:', error.message || '알 수 없는 오류');
            }
        });

        // 🎯 메인 페이지 서비스 데이터를 기반으로 체크박스 자동 선택
        function autoCheckServicesFromMainPage() {
            try {
                // URL 파라미터에서 서비스 데이터 읽기
                const urlParams = new URLSearchParams(window.location.search);
                const serviceData = [];
                
                // 서비스 데이터 수집 (최대 4개 서비스)
                for (let i = 1; i <= 4; i++) {
                    const serviceName = urlParams.get(`service_name_${i}`);
                    if (serviceName) {
                        serviceData.push(serviceName);
                    }
                }
                
                console.log('📝 메인 페이지에서 전달받은 서비스 데이터:', serviceData);
                
                if (serviceData.length > 0) {
                    // 먼저 모든 서비스 체크박스 초기화
                    document.querySelectorAll('input[name="services"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // 서비스명을 체크박스 값으로 매핑
                    const serviceMapping = {
                        '파라핀 포매': 'paraffin',
                        '동결절편': 'frozen',
                        // '특수염색': ['pas', 'masson', 'alcian_blue', 'pico_sirius_red', 'other_special'], // 특수염색은 autoDetectSpecialStainingFromTableData 함수에서 처리
                        '면역조직화학염색 (IHC)': 'ihc',
                        '면역형광염색 (IF)': 'if_staining',
                        '형광제자리부합법 (FISH)': 'fish',
                        'Tissue Microarray (TMA)': 'tma',
                        'DNA/RNA 추출': ['dna_extraction', 'rna_extraction']
                    };
                    
                    // 체크박스 자동 선택
                    serviceData.forEach(serviceName => {
                        const checkboxValues = serviceMapping[serviceName];
                        
                        if (checkboxValues) {
                            if (Array.isArray(checkboxValues)) {
                                // 특수염색이나 DNA/RNA 추출처럼 여러 체크박스가 매핑되는 경우
                                // 첫 번째 옵션만 체크 (사용자가 구체적으로 선택할 수 있도록)
                                const firstOption = checkboxValues[0];
                                const checkbox = document.querySelector(`input[name="services"][value="${firstOption}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log(`✅ 자동 체크됨: ${serviceName} -> ${firstOption}`);
                                }
                            } else {
                                // 단일 체크박스 매핑
                                const checkbox = document.querySelector(`input[name="services"][value="${checkboxValues}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log(`✅ 자동 체크됨: ${serviceName} -> ${checkboxValues}`);
                                }
                            }
                        } else {
                            console.log(`⚠️ 매핑되지 않은 서비스: ${serviceName}`);
                        }
                    });
                    
                    // 성공 메시지 표시
                    setTimeout(() => {
                        if (serviceData.length > 0) {
                            console.log(`🎉 메인 페이지에서 ${serviceData.length}개 서비스가 자동으로 선택되었습니다!`);
                        }
                    }, 200);
                } else {
                    console.log('📝 메인 페이지에서 전달받은 서비스 데이터가 없습니다.');
                }
                
            } catch (error) {
            console.log('서비스 자동 선택 중 오류 발생:', error.message || '알 수 없는 오류');
        }
        }




    </script>


    </script>

    <!-- 🚀 완전한 오류 무시 시스템 (강화된 버전) -->
    <script>
        // 🔧 안전한 DOM 접근 유틸리티
        window.safeDOM = {
            // 안전한 요소 찾기
            find: function(selector) {
                try {
                    return document.querySelector(selector);
                } catch (error) {
                    console.log('DOM 접근 오류 무시:', selector);
                    return null;
                }
            },
            
            // 안전한 요소 모두 찾기
            findAll: function(selector) {
                try {
                    return document.querySelectorAll(selector) || [];
                } catch (error) {
                    console.log('DOM 접근 오류 무시:', selector);
                    return [];
                }
            },
            
            // 안전한 innerHTML 설정
            setHTML: function(selector, html) {
                try {
                    const element = this.find(selector);
                    if (element) {
                        element.innerHTML = html;
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.log('innerHTML 설정 오류 무시:', selector);
                    return false;
                }
            },
            
            // 안전한 속성 설정
            setAttr: function(selector, attr, value) {
                try {
                    const element = this.find(selector);
                    if (element) {
                        element.setAttribute(attr, value);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.log('속성 설정 오류 무시:', selector, attr);
                    return false;
                }
            },
            
            // 안전한 값 설정
            setValue: function(selector, value) {
                try {
                    const element = this.find(selector);
                    if (element) {
                        element.value = value;
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.log('값 설정 오류 무시:', selector);
                    return false;
                }
            },
            
            // 안전한 이벤트 리스너 추가
            on: function(selector, event, handler) {
                try {
                    const element = this.find(selector);
                    if (element) {
                        element.addEventListener(event, handler);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.log('이벤트 리스너 추가 오류 무시:', selector, event);
                    return false;
                }
            }
        };
        
        // 🔧 안전한 XMLHttpRequest 래퍼
        window.safeXHR = function(options) {
            return new Promise((resolve, reject) => {
                try {
                    const xhr = new XMLHttpRequest();
                    
                    // 타임아웃 설정
                    xhr.timeout = options.timeout || 30000;
                    
                    // 이벤트 핸들러 설정 (모든 오류 무시)
                    xhr.onload = function() {
                        try {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve(xhr.responseText);
                            } else {
                                console.log('HTTP 오류 무시:', xhr.status);
                                reject(new Error(`HTTP ${xhr.status}`));
                            }
                        } catch (error) {
                            console.log('응답 처리 오류 무시:', error.message);
                            reject(error);
                        }
                    };
                    
                    xhr.onerror = function() {
                        console.log('네트워크 오류 무시');
                        reject(new Error('네트워크 오류'));
                    };
                    
                    xhr.ontimeout = function() {
                        console.log('타임아웃 오류 무시');
                        reject(new Error('타임아웃'));
                    };
                    
                    xhr.onabort = function() {
                        console.log('요청 중단 오류 무시');
                        reject(new Error('요청 중단'));
                    };
                    
                    // 요청 전송
                    xhr.open(options.method || 'GET', options.url, true);
                    
                    // 헤더 설정
                    if (options.headers) {
                        Object.keys(options.headers).forEach(key => {
                            try {
                                xhr.setRequestHeader(key, options.headers[key]);
                            } catch (error) {
                                console.log('헤더 설정 오류 무시:', key);
                            }
                        });
                    }
                    
                    // 데이터 전송
                    xhr.send(options.data || null);
                    
                } catch (error) {
                    console.log('XMLHttpRequest 생성 오류 무시:', error.message);
                    reject(error);
                }
            });
        };

        // 🚀 최강 전역 오류 핸들러 (모든 오류 완전 무시)
        window.addEventListener('error', function(event) {
            // 모든 JavaScript 오류 무시
            console.log('JavaScript 오류 무시:', event.message || '알 수 없는 오류');
            return true; // 오류 무시
        });
        
        // 🚀 Promise rejection 완전 무시
        window.addEventListener('unhandledrejection', function(event) {
            console.log('Promise rejection 무시:', event.reason?.message || event.reason);
            event.preventDefault(); // 콘솔 오류 방지
        });
        
        // 🚀 리소스 로드 오류 무시
        window.addEventListener('error', function(event) {
            if (event.target !== window) {
                console.log('리소스 로드 오류 무시:', event.target.src || event.target.href);
                return true;
            }
        }, true);
        
        // 🚀 네트워크 상태 변화 처리
        window.addEventListener('offline', function() {
            console.log('네트워크 연결 끊김 - 계속 진행');
        });
        
        window.addEventListener('online', function() {
            console.log('네트워크 연결 복원 - 계속 진행');
        });
        
        // 🚀 콘솔 오류 메시지 오버라이드 (선택적)
        const originalConsoleError = console.error;
        console.error = function(...args) {
            // 특정 오류 메시지들은 완전히 무시
            const errorMessage = args.join(' ');
            const shouldIgnore = [
                'Failed to fetch',
                'NetworkError',
                'CORS',
                'Cannot read properties of null',
                'Cannot set properties of null',
                'XMLHttpRequest',
                'Access to fetch',
                'net::ERR_',
                'html2canvas',
                'jsPDF',
                'Blocked by CORS policy',
                'The operation was aborted',
                'Request timed out',
                'Load failed',
                'SecurityError',
                'DOM Exception',
                'TypeError: Failed to fetch',
                'SyntaxError: Unexpected token'
            ].some(ignored => errorMessage.includes(ignored));
            
            if (!shouldIgnore) {
                originalConsoleError.apply(console, args);
            }
        };
        
        // 🚀 전역 함수 안전화
        window.safeCall = function(fn, ...args) {
            try {
                return fn(...args);
            } catch (error) {
                console.log('함수 호출 오류 무시:', error.message);
                return null;
            }
        };
        
        // 🚀 DOM 로드 완료 시 안전 시스템 활성화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🛡️ 완전한 오류 무시 시스템 활성화됨');
            console.log('🔧 안전한 DOM 접근: window.safeDOM 사용');
            console.log('🔧 안전한 XMLHttpRequest: window.safeXHR 사용');
            console.log('🔧 안전한 함수 호출: window.safeCall 사용');
        });
    </script>

    <!-- 🔧 환경 설정 파일 로드 -->
    <script src="js/config.js"></script>
    
    <!-- 🎯 특수염색 자동감지 기능 포함 메인 스크립트 로드 -->
    <script src="js/main.js"></script>
</body>
</html> 
